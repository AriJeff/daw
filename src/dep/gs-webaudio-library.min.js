"use strict";function gswaContext(){this.ctx=new window.AudioContext,this.destination=this.ctx.destination,this.filters=this.createFilters(),this.nbPlaying=0,this.filters.connect(this.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}function gswaComposition(t){this.wCtx=t,this.samples=[],this.isPlaying=this.isPaused=!1,this.oldDuration=this.duration=this._startedTime=this._currentTime=0,this._bpm=60,this.fnOnended=this.fnOnpaused=function(){},this.onended=this.onended.bind(this),this._add=this._add.bind(this),this._remove=this._remove.bind(this)}function gswaFilters(t){this.wCtx=t,this.nodes=[],this.nodeIn=t.ctx.createGain(),this.nodeOut=t.ctx.createGain(),this.nodeIn.connect(this.nodeOut),this.connect(t)}function gswaSampleGroup(){this.samples=[],this.samplesRev=[],this.updateDuration()}gswaContext.prototype={gain:function(t){return arguments.length?(this.filter.gain(t),this):this.filter.gain()},createSample:function(t){var n=new gswaSample(this,t);return t.samples.push(n),n},createBuffer:function(){return new gswaBuffer(this)},createFilters:function(){return new gswaFilters(this)},createComposition:function(){return new gswaComposition(this)}},gswaComposition.prototype={bpm:function(t){if(!arguments.length)return this._bpm;if(t=Math.max(1,t),t!==this._bpm){var n=this._bpm/60,i=n/(t/60),e=this.currentTime();this.samples.forEach(function(t){t.when*=i}),this.isLooping&&this.loop(this.loopWhen*i,this.loopDuration*i),this._bpm=t,this._updateDuration(),this.currentTime(e*i)}return this},add:function(t){return t.forEach?t.forEach(this._add):this._add(t),this},remove:function(t){return t.forEach?t.forEach(this._remove):this._remove(t),this},getSampleAt:function(t){return this.samples.findIndex(function(n){return n.when+n.duration>t})},update:function(t,n){return"rm"!==n&&this.samples.sort(function(t,n){return t.when<n.when?-1:t.when>n.when?1:0}),this._updateDuration(),this.oldDuration!==this.duration&&this._updateEndTimeout(),this.isPlaying&&(t.stop(),"rm"!==n&&(this.isLooping?this._loopUpdate(t):this._sampleStart(t,0,this.currentTime(),1/0))),this},currentTime:function(t){function n(t){return!i.isLooping||t<i.loopEnd?t:i.loopWhen+(t-i.loopWhen)%i.loopDuration}var i=this;return arguments.length?(this.isPlaying&&this._stop(),this._currentTime=n(Math.max(0,Math.min(t,this.duration))),this.isPlaying&&this._play(),this):this.isPlaying?n(this._currentTime+this.wCtx.ctx.currentTime-this._startedTime):this._currentTime},play:function(){return this.isPlaying||(this.isPlaying=!0,this.isPaused=!1,this._play()),this},stop:function(){return(this.isPlaying||this.isPaused)&&(this._stop(),this.onended()),this},pause:function(){return this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this._currentTime+=this.wCtx.ctx.currentTime-this._startedTime,this._startedTime=0,this._stop(),this.fnOnpaused()),this},onended:function(t){return"function"==typeof t?this.fnOnended=t:(this.isPlaying=this.isPaused=!1,this._startedTime=this._currentTime=0,this.fnOnended()),this},_add:function(t){this.samples.indexOf(t)<0&&(this.samples.push(t),t.composition=this,this.update(t,"ad"))},_remove:function(t){var n=this.samples.indexOf(t);n>-1&&(t.composition=null,this.samples.splice(n,1),this.update(t,"rm"))},_stop:function(){clearTimeout(this._endTimeout),clearTimeout(this._loopTimeout),this.samples.forEach(function(t){t.stop()})},_play:function(){this._startedTime=this.wCtx.ctx.currentTime,this.isLooping?this._loopPlay():this.samples.forEach(function(t){this._sampleStart(t,0,this.currentTime(),1/0)},this),this._updateEndTimeout()},_updateDuration:function(){var t=this.samples[this.samples.length-1];this.duration=t?t.when+t.duration:0},_updateEndTimeout:function(){if(clearTimeout(this._endTimeout),this.isPlaying&&!this.isLooping){var t=this.duration-this.currentTime();this.oldDuration=this.duration,t<=0?this.onended():this._endTimeout=setTimeout(this.onended,1e3*t)}},_sampleStart:function(t,n,i,e){var s=t.when,o=t.offset,h=t.duration,r=s-i;r>-h&&s<e&&(s+h>e&&(h-=s+h-e),r<0&&(o-=r,h+=r,r=0),t.start(r+n,o,h))}},gswaFilters.prototype={connect:function(t){t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.nodeOut.connect(t))},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},empty:function(){this.nodes.length&&(this.nodes[this.nodes.length-1].disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[])},gain:function(t){return arguments.length?void(this.nodeOut.gain.value=t):this.nodeOut.gain.value},pushBack:function(t){if(this.nodes.length){var n=this.nodes[this.nodes.length-1];n.disconnect(),n.connect(t)}else this.nodeIn.disconnect(),this.nodeIn.connect(t);t.connect(this.nodeOut),this.nodes.push(t)},pushFront:function(t){this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(t),t.connect(this.nodes[0]),this.nodes.unshift(t)):this.pushBack(t)},popBack:function(){var t=this.nodes.pop();if(t)if(t.disconnect(),this.nodes.length){var n=this.nodes[this.nodes.length-1];n.disconnect(),n.connect(this.nodeOut)}else this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut);return t},popFront:function(){var t=this.nodes.shift();return t&&(t.disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodes[0]||this.nodeOut)),t}},function(){function t(t){this.bufferSources.splice(this.bufferSources.indexOf(t),1)}window.gswaBufferSample=function(){this.bufferSources=[]},gswaBufferSample.prototype={setContext:function(t){this.ctx=t},setMetadata:function(t){t&&(this.duration=this.duration||t.duration)},setDataFromAudioBuffer:function(t){return this.buffer=t,this.setMetadata(t),t},setDataFromArrayBuffer:function(t){return this.ctx.decodeAudioData(t).then(this.setDataFromAudioBuffer.bind(this))},setDataFromBlob:function(t){var n=this,i=new FileReader;return new Promise(function(e,s){i.onloadend=function(){e(n.setDataFromArrayBuffer(i.result))},i.readAsArrayBuffer(t)})},setDataFromURL:function(t){return fetch(t).then(function(t){return t.arrayBuffer()}).then(this.setDataFromArrayBuffer.bind(this))},connect:function(t){this.connectedTo=t,this.bufferSources.forEach(function(n){n.connect(t)})},disconnect:function(){this.connectedTo=null,this.bufferSources.forEach(function(t){t.disconnect()})},start:function(n,i,e){var s,o=this.ctx,h=this.buffer;if(o&&h)return s=o.createBufferSource(),s.buffer=h,s.onended=t.bind(this,s),s.connect(this.connectedTo),this.bufferSources.push(s),s.start(n||0,i||0,arguments.length>2?e:this.duration),s},stop:function(){this.bufferSources.forEach(function(t){t.onended=null,t.stop()}),this.bufferSources.length=0}}}(),function(){function t(t,n){for(var i=0,e=0,s=t.length+n.length,o=new Float32Array(s);i<s;)o[i++]=t[e],o[i++]=n[e++];return o}function n(t,n,i){for(var e=0;e<i.length;++e)t.setUint8(n+e,i.charCodeAt(e))}function i(t,n,i){for(var e,s=0;s<i.length;++s,n+=2)e=Math.max(-1,Math.min(i[s],1)),t.setInt16(n,e<0?32768*e:32767*e,!0)}function e(t,n,i){for(var e=0;e<i.length;++e,n+=4)t.setFloat32(n,i[e],!0)}window.gswaEncodeWAV=function(s,o){var h=s.numberOfChannels,r=s.sampleRate,a=o&&o.float32?3:1,u=3===a?32:16,c=u/8,d=h*c,f=2===h?t(s.getChannelData(0),s.getChannelData(1)):s.getChannelData(0),l=new ArrayBuffer(44+f.length*c),p=new DataView(l);return n(p,0,"RIFF"),p.setUint32(4,36+f.length*c,!0),n(p,8,"WAVE"),n(p,12,"fmt "),p.setUint32(16,16,!0),p.setUint16(20,a,!0),p.setUint16(22,h,!0),p.setUint32(24,r,!0),p.setUint32(28,r*d,!0),p.setUint16(32,d,!0),p.setUint16(34,u,!0),n(p,36,"data"),p.setUint32(40,f.length*c,!0),(1===a?i:e)(p,44,f),l}}(),gswaSampleGroup.prototype={stretch:function(t){this.samples.forEach(function(n){n.whenRel*=t}),this.updateDuration()},start:function(t,n,i){var e=this.samples[0];e&&(n=n||0,i=arguments.length>2?i:this.duration,t||(t=e.sample.ctx.currentTime),this.samples.forEach(function(e){var s=e.whenRel-n,o=e.duration,h=e.offset;s<0&&(h-=s,o+=s),o>0&&(o+=Math.min(i-s-o,0),o>0&&e.sample.start(t+s,h,o))}))},stop:function(){this.samples.forEach(function(t){t.sample.stop()})},addSample:function(t){t.offset=t.offset||0,t.duration=t.duration||t.sample.duration,this.samples.push(t),this.samplesRev.push(t)},addSamples:function(t){t.forEach(this.addSample.bind(this))},removeSample:function(t){this.samples.splice(this.samples.indexOf(t),1),this.samplesRev.splice(this.samplesRev.indexOf(t),1)},removeSamples:function(t){t.forEach(this.removeSample.bind(this))},updateDuration:function(){var t=this.samplesRev[0];this.duration=t?t.whenRel+t.duration:0},sortSamples:function(){function t(t,n){return t<n?-1:t>n?1:0}this.samples.sort(function(n,i){return t(n.whenRel,i.whenRel)}),this.samplesRev.sort(function(n,i){return t(i.whenRel+i.duration,n.whenRel+n.duration)})}};