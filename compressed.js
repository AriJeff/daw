"use strict";function walContext(){this.ctx=new AudioContext,this.destination=this.ctx.destination,this.buffers=[],this.compositions=[],this.nbPlaying=0,this.gainNode=this.ctx.createGain(),this.filters=this.createFilters(),this.filters.pushBack(this.gainNode),this.filters.connect(this.ctx.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}walContext.prototype={gain:function(i){return arguments.length?(this.gainNode.gain.value=i,this):this.gainNode.gain.value},createBuffer:function(i,t){var e=new walContext.Buffer(this,i,t);return this.buffers.push(e),e},createFilters:function(){return new walContext.Filters(this)},createComposition:function(){var i=new walContext.Composition(this);return this.compositions.push(i),i}},function(){walContext.Composition=function(i){this.wCtx=i,this.wSamples=[],this.lastSample=null,this.fnOnended=function(){},this.fnOnpaused=function(){},this.startedTime=0,this.pausedOffset=0,this.isPlaying=!1},walContext.Composition.prototype={addSamples:function(i){var t=this;i.forEach(function(i){-1===t.wSamples.indexOf(i)&&((null===t.lastSample||i.getEndTime()>t.lastSample.getEndTime())&&(t.lastSample=i),t.wSamples.push(i),i.setComposition(i))})},removeSamples:function(i){var t,e=this;i.forEach(function(i){-1!==(t=e.wSamples.indexOf(i))&&(e.wSamples.splice(t,1),i.setComposition(null),i===e.lastSample&&(e.lastSample=e.getLastSample()))})},updateSamples:function(i){-1!==this.wSamples.indexOf(i)&&(i!==this.lastSample&&i.getEndTime()>this.lastSample.getEndTime()?this.lastSample=i:i===this.lastSample&&this.wSamples.length>1&&(this.lastSample=this.getLastSample()))},loadSamples:function(i){return this.isPlaying||this.wSamples.forEach(function(t){(!i||t.getEndTime()>i)&&t.load()}),this},playSamples:function(i){var t,e;return this.wSamples.length&&!this.isPlaying&&(this.startedTime=wa.wctx.ctx.currentTime,i&&(this.pausedOffset=i),this.isPlaying=!0,this.wSamples.forEach(function(n){(!i||n.getEndTime()>i)&&(e=i?n.when-i:n.when,t=i?i-n.when:n.offset,n.start(e,0>t?0:t))}),this.playTimeoutId=setTimeout(this.onended.bind(this),1e3*(this.lastSample.getEndTime()-this.pausedOffset))),this},stopSamples:function(i){return this.wSamples.forEach(function(i){i.stop()}),this.onended(),this},pauseSamples:function(){this.isPlaying&&(this.pausedOffset+=wa.wctx.ctx.currentTime-this.startedTime,this.wSamples.forEach(function(i){i.stop()}),clearTimeout(this.playTimeoutId),this.startedTime=0,this.isPlaying=!1,this.fnOnpaused())},getLastSample:function(){var i,t,e=null;return this.wSamples.length&&(e=this.wSamples[0],i=e.getEndTime(),this.wSamples.forEach(function(n){t=n.getEndTime(),t>i&&(e=n,i=t)})),e},getOffset:function(){return this.isPlaying?this.pausedOffset+wa.wctx.ctx.currentTime-this.startedTime:this.pausedOffset},onended:function(i){return"function"==typeof i?this.fnOnended=i:(this.playTimeoutId&&clearTimeout(this.playTimeoutId),this.startedTime=0,this.isPlaying=!1,this.pausedOffset=0,this.fnOnended()),this}}}(),function(){walContext.Buffer=function(i,t,e){function n(i){s.wCtx.ctx.decodeAudioData(i,function(i){s.buffer=i,s.isReady=!0,e&&e(s)})}var s=this,o=new FileReader;this.wCtx=i,this.isReady=!1,t.name?(o.addEventListener("loadend",function(){n(o.result)}),o.readAsArrayBuffer(t)):n(t)},walContext.Buffer.prototype={createSample:function(){var i=new walContext.Sample(this.wCtx,this);return i},getPeaks:function(i,t,e,n){e=e||0,n=n||this.buffer.duration;for(var s,o,a,u=0,r=new Array(t),c=this.buffer.getChannelData(i),l=(n-e)*this.buffer.sampleRate,d=e*this.buffer.sampleRate,h=l/t,m=h/10;t>u;++u){for(s=d+u*h,o=s+h,a=0;o>s;s+=m)a=Math.max(a,Math.abs(c[~~s]));r[u]=a}return r}}}(),function(){function i(i,t,e){i[t]=e[0],i[t+1]=e[1],i[t+2]=e[2],i[t+3]=e[3]}function t(t,e,n,s){var o,a,u,r=e.data,c=0,l=e.width,d=e.height,h=d/2,m=t.getPeaks(0,l),f=t.buffer.numberOfChannels>1?t.getPeaks(1,l):m;if(s){for(;c<r.length;c+=4)i(r,c,n);n=[0,0,0,0]}for(c=0;l>c;++c){for(a=~~(h*(1-m[c])),u=~~(h*(1+f[c])),o=a;u>=o;++o)i(r,4*(o*l+c),n);i(r,4*(h*l+c),n)}return e}walContext.Buffer.prototype.drawWaveform=function(i,e){return t(this,i,e)},walContext.Buffer.prototype.drawInvertedWaveform=function(i,e){return t(this,i,e,!0)}}(),walContext.Filters=function(i){this.wCtx=i,this.nodes=[],this.nodeIn=i.ctx.createGain(),this.nodeOut=i.ctx.createGain(),this.nodeIn.connect(this.nodeOut)},walContext.Filters.prototype={pushBack:function(i){this.nodes.length>0?(this.nodes[this.nodes.length-1].disconnect(),this.nodes[this.nodes.length-1].connect(i)):(this.nodeIn.disconnect(),this.nodeIn.connect(i)),i.connect(this.nodeOut),this.nodes.push(i)},pushFront:function(i){0===this.nodes.length?this.pushBack(i):(this.nodeIn.disconnect(),this.nodeIn.connect(i),this.nodes.unshift(i),i.connect(this.nodes[1]))},popBack:function(){var i=this.nodes.length?this.nodes.pop():null;return i&&(i.disconnect(),0===this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut)):(this.nodes[this.nodes.length-1].disconnect(),this.nodes[this.nodes.length-1].connect(this.nodeOut))),i},popFront:function(){var i;return this.nodes.length?1===this.nodes.length?i=this.popBack():(this.nodeIn.disconnect(),this.nodes[0].disconnect(),i=this.nodes.shift(),this.nodeIn.connect(this.nodes[0])):i=null,i},popAll:function(){if(this.nodes.length>0){var i=this.nodes;return this.nodeIn.disconnect(),i[i.length-1].disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[],i}return null},connect:function(i){i=i.nodeIn||i,this.nodeOut.connect(i),this.connectedTo=i},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},gain:function(i){return arguments.length?(this.gainNode.gain.value=i,this):this.gainNode.gain.value}},walContext.Sample=function(i,t,e){this.wCtx=i,this.wBuffer=t,this.connectedTo=e?e.nodeIn:i.nodeIn,this.fnOnended=function(){},this.when=0,this.offset=0,this.duration=t.buffer.duration,this.bufferDuration=t.buffer.duration,this.composition=null,this.started=this.playing=!1},walContext.Sample.prototype={connect:function(i){return this.connectedTo=i.nodeIn||i,this.source&&this.source.connect(this.connectedTo),this},disconnect:function(){return this.source&&(this.source.disconnect(),this.connectedTo=null),this},setComposition:function(i){this.composition=i},load:function(){return this.isLoaded||(this.isLoaded=!0,this.source=this.wCtx.ctx.createBufferSource(),this.source.buffer=this.wBuffer.buffer,this.source.onended=this.onended.bind(this),this.connectedTo&&this.source.connect(this.connectedTo)),this},start:function(i,t,e){function n(){++s.wCtx.nbPlaying,s.playing=!0}var s=this;return this.isLoaded?this.started?console.warn("WebAudio Library: can not start a sample twice."):(this.started=!0,i=void 0!==i?i:this.when,this.source.start(this.wCtx.ctx.currentTime+i,void 0!==t?t:this.offset,void 0!==e?e:this.duration),i?this.playTimeoutId=setTimeout(n,1e3*i):n()):console.warn("WebAudio Library: can not start an unloaded sample."),this},stop:function(){return this.started&&this.source.stop(0),this},setWhen:function(i){this.when=i},setOffset:function(i){this.offset=i>0?i:0},setDuration:function(i){this.duration=i},getWhen:function(){return this.when},getOffset:function(){return this.offset},getDuration:function(){return this.duration},getEndTime:function(){var i=this.duration+this.offset>this.bufferDuration?this.bufferDuration-this.offset:this.duration;return this.when+i},onended:function(i){return"function"==typeof i?this.fnOnended=i:(this.playing&&(this.playing=!1,--this.wCtx.nbPlaying),this.started&&(this.started=!1,clearTimeout(this.playTimeoutId)),this.isLoaded=!1,this.source=null,this.fnOnended()),this}},window.wa={},wa.wctx=new walContext,wa.ctx=wa.wctx.ctx,wa.composition=wa.wctx.createComposition(),wa.analyser=wa.ctx.createAnalyser(),wa.analyser.fftSize=1024,wa.wctx.filters.pushBack(wa.analyser),wa.analyserArray=new Uint8Array(wa.analyser.frequencyBinCount),wa.oscilloscope=function(){var i=0,t=Math.PI/2;return function(e,n,s){var o,a=0,u=e.width,r=e.height,c=s.length,l=c/2,d=u/c;for(n.globalCompositeOperation="source-in",n.fillStyle="rgba("+Math.round(255-255*i)+","+Math.round(64*i)+","+Math.round(255*i)+","+(.95-.25*(1-Math.cos(i*t)))+")",n.fillRect(0,0,u,r),i=0,n.globalCompositeOperation="source-over",n.save(),n.translate(0,r/2),n.beginPath(),n.moveTo(0,0);c>a;++a)o=(s[a]-128)/128,i=Math.max(Math.abs(o),i),o*=.5-Math.cos((l>a?a:c-a)/l*Math.PI)/2,n.lineTo(a*d,o*r);n.lineJoin="round",n.lineWidth=1+Math.round(2*i),n.strokeStyle="rgba(200,200,255,"+Math.min(5*i,1)+")",n.stroke(),n.restore()}}(),function(){function i(){if(--e>0){var n=wa.composition.getOffset();ui.setClockTime(n),ui.setCursorTime(n),t=requestAnimationFrame(i)}}var t,e;wa.compositionLoop=function(t){t?(e=1/0,i()):e=2}}(),function(){function i(t){for(var e,n=t.firstChild;null!==n;)i(e=n),n=n.nextSibling,1!==e.nodeType&&/^\s*$/.test(e.textContent)&&t.removeChild(e)}i(document.body)}(),window.ui={jqWindow:$(window),jqBody:$("body"),jqVisual:$("#visual"),jqVisualCanvas:$("#visual canvas"),jqClockMin:$("#visual .clock .min"),jqClockSec:$("#visual .clock .sec"),jqClockMs:$("#visual .clock .ms"),jqMenu:$("#menu"),jqPlay:$("#menu .btn.play"),jqStop:$("#menu .btn.stop"),jqBpmA:$("#menu .bpm .a-bpm"),jqBpmInt:$("#menu .bpm .int"),jqBpmDec:$("#menu .bpm .dec"),jqBpmList:$("#menu .bpm-list"),jqBtnTools:$("#menu .tools [data-tool]"),jqBtnMagnet:$("#menu .tools .magnet"),jqFiles:$("#files"),jqFilelist:$("#files .filelist"),jqGrid:$("#grid"),jqGridEm:$("#grid .emWrapper"),jqGridHeader:$("#grid .header"),jqTimeline:$("#grid .timeline"),jqTimeCursor:$("#grid .timeCursor"),jqTrackList:$("#grid .trackList"),jqGridCols:$("#grid .cols"),jqGridColB:$("#grid .colB"),jqTrackNames:$("#grid .trackNames"),jqTrackLines:$("#grid .trackLines"),jqTrackLinesBg:$("#grid .trackLinesBg"),jqTrackNamesExtend:$("#grid .trackNames .extend")},ui.gridEm=parseFloat(ui.jqGrid.css("fontSize")),ui.tool={},ui.files=[],ui.tracks=[],ui.samples=[],ui.selectedSamples=[],ui.nbTracksOn=0,ui.gridColsY=ui.jqGridCols.offset().top,ui.jqVisualCanvas[0].height=ui.jqVisualCanvas.height(),ui.getGridXem=function(i){var t,e=.25,n=(i-ui.filesWidth-ui.trackNamesWidth-ui.trackLinesLeft)/ui.gridEm;return ui.isMagnetized&&(t=n%e,n-=t,t>e/2&&(n+=e)),n},function(){function i(){var o=e;wa.wctx.nbPlaying&&(o=wa.analyserArray,wa.analyser.getByteTimeDomainData(o)),wa.oscilloscope(n,s,o),t=requestAnimationFrame(i)}var t,e=[],n=ui.jqVisualCanvas[0],s=n.getContext("2d");ui.analyserEnabled=!1,ui.analyserToggle=function(e){"boolean"!=typeof e&&(e=!ui.analyserEnabled),ui.analyserEnabled=e,e?t=requestAnimationFrame(i):(s.clearRect(0,0,n.width,n.height),cancelAnimationFrame(t))}}(),function(){var i,t=$("<div class='cursor'>");ui.playFile=function(e){i&&i.stop(),e.isLoaded&&(t.css("transitionDuration",0).css("left",0),e.jqCanvasWaveform.after(t),i=e.wbuff.createSample().load().start(),setTimeout(function(){t.css("transitionDuration",e.wbuff.buffer.duration+"s").css("left","100%")},20))},ui.stopFile=function(){i&&(i.stop(),t.detach())}}(),ui.playComposition=function(){if(!wa.composition.isPlaying){var i=wa.composition.pausedOffset;wa.composition.loadSamples(i),wa.composition.playSamples(i),wa.compositionLoop(!0)}},ui.stopComposition=function(){wa.composition.stopSamples(),wa.compositionLoop(!1)},ui.pauseComposition=function(){wa.composition.isPlaying&&(wa.composition.pauseSamples(),wa.compositionLoop(!1))},ui.selectTool=function(){var i;return function(t){var e=ui.jqBtnTools.tool[t];e!==i&&(i&&i.classList.remove("active"),i=e,ui.jqGrid[0].dataset.tool=ui.currentTool=t,e.classList.add("active"))}}(),ui.setBPM=function(i){ui.BPM=i=Math.max(20,Math.min(i,999)),ui.BPMem=ui.BPM/60;var t=~~i,e=Math.min(Math.round(100*(i-t)),99);ui.jqBpmInt.text(100>t?"0"+t:t),ui.jqBpmDec.text(10>e?"0"+e:e),ui.samples.forEach(function(i){i.updateBPMem()})},ui.setClockTime=function(i){ui.clockTime=i,ui.jqClockMin.text(~~(i/60));var t=~~(i%60);ui.jqClockSec.text(10>t?"0"+t:t),i=Math.round(1e3*(i-~~i)),10>i?i="00"+i:100>i&&(i="0"+i),ui.jqClockMs.text(i)},ui.setCursorTime=function(i){i>0&&ui.jqTimeCursor.css("left",i*ui.BPMem+"em"),ui.jqTimeCursor[0].classList.toggle("visible",i>0)},ui.gridTop=0,ui.setGridTop=function(i){if(i>=0)i=0;else{var t=ui.tracks.length*ui.gridEm-ui.gridColsHeight;-t>i&&(i=-t)}ui.gridTop=i,ui.jqGridCols.css("top",i/ui.gridEm+"em")},ui.gridZoom=1,ui.setGridZoom=function(i,t,e){i=Math.min(Math.max(1,i),8);var n=i/ui.gridZoom;ui.gridZoom=i,ui.gridEm*=n,ui.jqGridEm.css("fontSize",i+"em"),ui.jqGrid.attr("data-sample-size",ui.gridEm<40?"small":ui.gridEm<80?"medium":"big"),ui.setGridTop(e-(-ui.gridTop+e)*n),ui.setTrackLinesLeft(t-(-ui.trackLinesLeft+t)*n),ui.updateTimeline(),ui.updateTrackLinesBg()},ui.setFilesWidth=function(i){ui.jqFiles.css("width",i),ui.filesWidth=i=ui.jqFiles.outerWidth(),ui.gridColsWidth=ui.screenWidth-i,ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.jqGrid.css("left",i),ui.jqVisual.css("width",i+ui.trackNamesWidth),ui.jqMenu.css("left",i+ui.trackNamesWidth),ui.jqVisualCanvas[0].width=ui.jqVisualCanvas.width(),ui.updateTimeline(),ui.updateTrackLinesBg()},ui.setTrackLinesLeft=function(i){ui.trackLinesLeft=i=Math.min(~~i,0),ui.jqTrackLines.css("left",i/ui.gridEm+"em")},ui.trackNamesWidth=0,ui.setTrackNamesWidth=function(i){var t,e=ui.trackNamesWidth;ui.jqTrackNames.css("width",i),ui.trackNamesWidth=i=ui.jqTrackNames.outerWidth(),ui.trackLinesWidth=ui.gridColsWidth-i,t=ui.filesWidth+i,ui.jqGridColB.css("left",i),ui.jqTimeline.css("left",i),ui.jqVisual.css("width",t),ui.jqMenu.css("left",t),ui.jqVisualCanvas[0].width=t,ui.trackLinesLeft<0&&ui.setTrackLinesLeft(ui.trackLinesLeft-(i-e)),ui.updateTimeline(),ui.updateTrackLinesBg(),ui.updateGridBoxShadow()},function(){function i(i){if(i>e){var n="",s=e;for(e=i;s++<i;)n+="<div><span></span></div>";ui.jqTimeline.append(n),t=t||ui.jqTimeline.children().eq(0)}}var t,e=0;ui.updateTimeline=function(){var e=ui.trackLinesLeft/ui.gridEm,n=ui.trackLinesWidth/ui.gridEm;i(Math.ceil(-e+n)),t&&t.css("marginLeft",e+"em")}}(),function(){function i(i){var n,s,o,a=i-e,u="";for(e=Math.max(i,e),n=0;a>n;++n){for(u+="<div>",s=0;4>s;++s){for(u+="<div>",o=0;4>o;++o)u+="<div></div>";u+="</div>"}u+="</div>"}ui.jqTrackLinesBg.append(u),t=t||ui.jqTrackLinesBg.children().eq(0)}var t,e=0;ui.updateTrackLinesBg=function(){i(Math.ceil(ui.trackLinesWidth/ui.gridEm/4)+2),t.css("marginLeft",ui.trackLinesLeft/ui.gridEm%8+"em")}}(),ui.updateGridBoxShadow=function(){function i(i,t){return(i=i||t)?(i=Math.min(2-i/8,5),(t?"0px "+i:i+"px 0")+"px 2px rgba(0,0,0,.3)"):"none"}ui.jqGridHeader.css("boxShadow",i(0,ui.gridTop)),ui.jqTrackNames.css("boxShadow",i(ui.trackLinesLeft,0))},ui.resize=function(){ui.screenWidth=ui.jqWindow.width(),ui.screenHeight=ui.jqWindow.height(),ui.gridColsWidth=ui.jqGridCols.width(),ui.gridColsHeight=ui.jqTrackList.height(),ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.updateTimeline(),ui.updateTrackLinesBg()},ui.toggleTracks=function(i){for(var t,e=0,n=i.isOn&&1===ui.nbTracksOn;t=ui.tracks[e++];)t.toggle(n);i.toggle(!0)},ui.isMagnetized=!1,ui.toggleMagnetism=function(i){"boolean"!=typeof i&&(i=!ui.isMagnetized),ui.isMagnetized=i,ui.jqBtnMagnet.toggleClass("active",i)},ui.newFile=function(i){var t=new ui.File(i);ui.files.push(t),ui.jqFilelist.append(t.jqFile)},ui.newTrack=function(){ui.tracks.push(new ui.Track(this))},ui.sampleCreate=function(i,t,e){var n=new ui.Sample(i).inTrack(t).moveX(e);return ui.samplesFixPosition(n),ui.samples.push(n),wa.composition.addSamples([n.wsample]),n},ui.sampleSelect=function(i,t){i&&i.selected!==t&&(i.select(t),t?ui.selectedSamples.push(i):ui.selectedSamples.splice(ui.selectedSamples.indexOf(i),1))},ui.sampleDelete=function(i){i&&(ui.sampleSelect(i,!1),ui.samples.splice(ui.samples.indexOf(i),1),i["delete"]())},ui.samplesForEach=function(i,t){i&&(i.selected?ui.selectedSamples.forEach(t):t(i))},ui.samplesFixPosition=function(i){ui.isMagnetized&&ui.samplesForEach(i,function(i){i.xemMouse=i.xemMagnet})},ui.samplesMoveX=function(i,t){if(i.selected&&0>t){var e=1/0;ui.selectedSamples.forEach(function(i){e=Math.min(e,i.xem)}),t=-Math.min(e,-t)}ui.samplesForEach(i,function(i){i.moveX(Math.max(0,i.xem+t)),wa.composition.updateSamples(i.wsample)})},ui.samplesSlip=function(i,t){t/=ui.BPMem,ui.samplesForEach(i,function(i){i.slip(i.offset+t)})},ui.samplesUnselect=function(){ui.selectedSamples.forEach(function(i){i.select(!1)}),ui.selectedSamples=[]},ui.File=function(i){var t=this;this.file=i,this.fullname=i.name,this.name=i.name.replace(/\.[^.]+$/,""),this.isLoaded=this.isLoading=!1,this.jqFile=$("<a class='sample to-load' draggable='true'>"),this.jqName=$("<span class='text-overflow'>").appendTo(this.jqFile).text(this.name),this.jqToLoad=$("<i class='to-load fa fa-fw fa-download'>").prependTo(this.jqName),this.jqFile.on({contextmenu:!1,dragstart:this.dragstart.bind(this),mousedown:function(i){0!==i.button&&ui.stopFile()},click:function(){t.isLoaded?ui.playFile(t):t.isLoading||t.loaded()}})},function(){var i,t;ui.jqBody.mousemove(function(e){i&&t.css({left:e.pageX,top:e.pageY})}).mouseup(function(e){if(i){var n=Math.floor((e.pageY-ui.gridColsY-ui.gridTop)/ui.gridEm),s=ui.getGridXem(e.pageX);t.remove(),n>=0&&s>=0&&ui.sampleCreate(i,n,s),i=null}}),ui.File.prototype.dragstart=function(e){if(this.isLoaded&&!i){i=this,t=this.jqCanvasWaveform.clone();var n=t[0];n.getContext("2d").drawImage(this.jqCanvasWaveform[0],0,0,n.width,n.height),t.addClass("dragging").css({left:e.pageX,top:e.pageY}).appendTo(ui.jqBody)}return!1}}(),ui.File.prototype.loaded=function(){var i=this;this.isLoading=!0,this.jqToLoad.removeClass("fa-downloads").addClass("fa-refresh fa-spin"),wa.wctx.createBuffer(this.file,function(t){var e,n,s;i.wbuff=t,i.isLoaded=!0,i.isLoading=!1,i.jqFile.removeClass("to-load"),i.jqToLoad.remove(),i.jqCanvasWaveform=$("<canvas class='waveform'>"),e=i.jqCanvasWaveform[0],n=e.getContext("2d"),e.width=400,e.height=50,s=n.createImageData(e.width,e.height),t.drawWaveform(s,[57,57,90,255]),n.putImageData(s,0,0),i.jqFile.prepend(e),ui.playFile(i)})},ui.Track=function(i,t){t=t||{},this.grid=i,this.id=ui.tracks.length,this.jqColNamesTrack=$("<div class='track'>").appendTo(ui.jqTrackNames),this.jqColLinesTrack=$("<div class='track'>").appendTo(ui.jqTrackLines),this.jqColNamesTrack[0].uitrack,this.jqColLinesTrack[0].uitrack=this,this.initToggle().initEditName().toggle(t.toggle!==!1).editName(t.name||"")},ui.Track.prototype.initEditName=function(){var i=this;return this.jqName=$("<span class='name text-overflow'>").appendTo(this.jqColNamesTrack).dblclick(this.editName.bind(this,!0)),this.jqNameInput=$("<input type='text'/>").appendTo(this.jqColNamesTrack).blur(function(){i.editName(this.value).editName(!1)}).keydown(function(t){13!==t.keyCode&&27!==t.keyCode||i.editName(13===t.keyCode?this.value:i.name).editName(!1),t.stopPropagation()}),this},ui.Track.prototype.editName=function(i){var t=this.jqNameInput[0],e="Track "+(this.id+1);return"string"==typeof i?(i=i.replace(/^\s+|\s+$/,"").replace(/\s+/g," "),i=i===e?"":i,this.jqName.toggleClass("empty",""===i).text(i||e),this.name=i):i?(this.jqColNamesTrack.addClass("editing"),t.value=this.name||e,t.focus(),t.select()):(t.blur(),this.jqColNamesTrack.removeClass("editing")),this},ui.Track.prototype.initToggle=function(){var i=this;return this.jqToggle=$("<a class='toggle'>").appendTo(this.jqColNamesTrack).on("contextmenu",!1).mousedown(function(t){0===t.button?i.toggle():2===t.button&&ui.toggleTracks(i)}),this},ui.Track.prototype.toggle=function(i){return"boolean"!=typeof i&&(i=!this.isOn),this.isOn!==i&&(this.isOn=i,this.grid.nbTracksOn+=i?1:-1,this.jqToggle.toggleClass("on",i),this.jqColNamesTrack.add(this.jqColLinesTrack).toggleClass("off",!i)),this},ui.Sample=function(i){var t,e,n;this.xemMagnet=0,this.uifile=i,this.wbuff=i.wbuff,this.offset=0,this.wsample=this.wbuff.createSample(),this.jqSample=$("<div class='sample'>"),this.jqWaveformWrapper=$("<div class='waveformWrapper'>").appendTo(this.jqSample),this.jqWaveform=$("<canvas class='waveform'>").appendTo(this.jqWaveformWrapper),t=this.jqWaveform[0],e=t.getContext("2d"),t.width=~~(300*this.wbuff.buffer.duration),t.height=50,n=e.createImageData(t.width,t.height),this.wbuff.drawWaveform(n,[221,221,255,255]),e.putImageData(n,0,0),this.jqName=$("<span class='text-overflow'>").text(i.name).appendTo(this.jqSample),this.jqName[0].uisample=this.jqWaveformWrapper[0].uisample=this.jqWaveform[0].uisample=this,this.updateCSS_width(),this.select(!1)},ui.Sample.prototype.when=function(i){return this.wsample.when=i,this.updateCSS_when(),this},ui.Sample.prototype.slip=function(i){return this.offset=Math.max(-this.wbuff.buffer.duration,Math.min(i,0)),this.updateCSS_offset(),this},ui.Sample.prototype.mute=function(){return lg("sample muted (in development)"),this},ui.Sample.prototype.select=function(i){return this.selected=i,this.jqSample.toggleClass("selected",i),this},ui.Sample.prototype["delete"]=function(){return this.jqSample.remove(),this.wsample.stop(),wa.composition.removeSamples([this.wsample]),this},ui.Sample.prototype.inTrack=function(i){var t=ui.tracks[i];return t!==this.track&&(this.track=t,this.track.jqColLinesTrack.append(this.jqSample)),this},ui.Sample.prototype.moveX=function(i){return this.xem=i,this.when(i/ui.BPMem),this},ui.Sample.prototype.updateBPMem=function(){return this.wsample.when=this.xem/ui.BPMem,this.updateCSS_width(),this.updateCSS_offset(),this},ui.Sample.prototype.updateCSS_when=function(){return this.jqSample.css("left",this.wsample.when*ui.BPMem+"em"),this},ui.Sample.prototype.updateCSS_offset=function(){return this.jqWaveform.css("marginLeft",this.offset*ui.BPMem+"em"),this},ui.Sample.prototype.updateCSS_width=function(){return this.jqSample.css("width",this.wbuff.buffer.duration*ui.BPMem+"em"),this},ui.jqBpmA.mousedown(function(){return ui.jqBpmA.toggleClass("clicked"),!1}),ui.jqBpmList.children().mousedown(function(){ui.setBPM(+this.textContent)}),ui.jqBody.mousedown(function(){ui.jqBpmA.removeClass("clicked")}),ui.jqBpmInt.on("wheel",function(i){i=i.originalEvent.deltaY,ui.setBPM(ui.BPM+(i>0?-1:i?1:0))}),ui.jqBpmDec.on("wheel",function(i){i=i.originalEvent.deltaY,ui.setBPM(ui.BPM+(i>0?-.01:i?.01:0))}),function(){var i,t=!1,e={files:function(i){var t=i.pageX;ui.setFilesWidth(35>t?0:t)},trackNames:function(i){var t=i.pageX-ui.jqGrid.offset().left;ui.setTrackNamesWidth(35>t?0:t)}};$(".extend").mousedown(function(n){0===n.button&&(t=!0,ui.jqBody.addClass("cursor-ewResize"),i=e[this.dataset.mousemoveFn])}),ui.jqBody.mouseup(function(i){0===i.button&&t&&(t=!1,ui.jqBody.removeClass("cursor-ewResize"))}).mousemove(function(e){t&&i(e)})}(),ui.jqBody.on({dragover:!1,drop:function(i){i=i.originalEvent;var t=i&&i.dataTransfer;return $.each(t&&t.files,function(){ui.newFile(this)}),!1}}),function(){function i(){e&&(ui.selectTool(e),e=null),t=!1}var t,e,n,s=0,o=0;ui.jqWindow.blur(i),ui.jqTrackLines.on({contextmenu:!1,mousedown:function(i){if(!t){t=!0,n=ui.getGridXem(i.pageX),s=i.pageX,o=i.pageY,2===i.button&&(e=ui.currentTool,ui.selectTool("delete"));var a=ui.tool[ui.currentTool].mousedown;a&&a(i,i.target.uisample)}}}),ui.jqGrid.on("wheel",function(i){i=i.originalEvent,"zoom"===ui.currentTool?ui.tool.zoom.wheel(i):ui.setGridTop(ui.gridTop+(i.deltaY<0?.9:-.9)*ui.gridEm),ui.updateGridBoxShadow()}),ui.jqBody.on({mousemove:function(i){if(t){var e=ui.tool[ui.currentTool].mousemove,a=ui.getGridXem(i.pageX);e&&e(i,i.target.uisample,"hand"!==ui.currentTool?(a-n)*ui.gridEm:i.pageX-s,i.pageY-o),n=a,s=i.pageX,o=i.pageY}},mouseup:function(e){if(t){var n=ui.tool[ui.currentTool].mouseup;n&&n(e,e.target.uisample),i()}},wheel:function(i){return i.ctrlKey?!1:void 0}})}(),function(){function i(){t&&(ui.selectTool(t),t=null)}var t,e={16:"select",86:"select",66:"paint",68:"delete",77:"mute",83:"slip",67:"cut",32:"hand",72:"hand",17:"zoom",90:"zoom"};ui.jqWindow.blur(i),ui.jqBody.keydown(function(i){if(i=i.keyCode,8===i)return ui.toggleMagnetism(),!1;var n=e[i];n&&n!==ui.currentTool&&(16!==i&&17!==i&&32!==i||(t=ui.currentTool),ui.selectTool(n))}).keyup(function(t){t=t.keyCode,16!==t&&17!==t&&32!==t||i()})}(),ui.jqStop.click(function(){ui.stopFile(),ui.stopComposition()}),ui.jqPlay.click(function(){ui.playComposition()}),ui.jqWindow.on("resize",function(){ui.resize()}),ui.jqBtnMagnet.click(ui.toggleMagnetism),ui.jqBtnTools.tool={},ui.jqBtnTools.each(function(){ui.jqBtnTools.tool[this.dataset.tool]=this}).click(function(){ui.selectTool(this.dataset.tool)}),ui.tool["delete"]={mousedown:function(i,t){ui.sampleDelete(t)},mousemove:function(i,t){ui.sampleDelete(t)}},ui.tool.hand={mousedown:function(){ui.jqBody.addClass("cursor-move")},mouseup:function(){ui.jqBody.removeClass("cursor-move")},mousemove:function(i,t,e,n){ui.setTrackLinesLeft(ui.trackLinesLeft+e),ui.setGridTop(ui.gridTop+n),ui.updateTimeline(),ui.updateTrackLinesBg(),ui.updateGridBoxShadow()}},ui.tool.mute={mousedown:function(i,t){t&&t.mute()},mousemove:function(i,t){t&&t.mute()}},function(){var i;ui.tool.paint={mousedown:function(t,e){i=e},mouseup:function(){i&&(ui.samplesFixPosition(i),i=null)},mousemove:function(t,e,n,s){if(i){ui.samplesMoveX(i,n/ui.gridEm),t=t.target;var o,a=1/0,u=t.uitrack||t.uisample&&t.uisample.track;u&&(i.selected?(o=u.id-i.track.id,0>o&&(ui.selectedSamples.forEach(function(i){a=Math.min(i.track.id,a)}),o=-Math.min(a,-o)),ui.selectedSamples.forEach(function(i){i.inTrack(i.track.id+o)})):i.inTrack(u.id))}}}}(),ui.tool.select={mousedown:function(i,t){i.shiftKey||ui.samplesUnselect(),t&&ui.sampleSelect(t,!t.selected)}},function(){var i;ui.tool.slip={mousedown:function(t,e){i=e},mouseup:function(){i=null},mousemove:function(t,e,n){i&&ui.samplesSlip(i,n/ui.gridEm)}}}(),function(){function i(i,t){ui.setGridZoom(ui.gridZoom*t,i.pageX-ui.filesWidth-ui.trackNamesWidth,i.pageY-ui.gridColsY)}ui.tool.zoom={wheel:function(t){i(t,t.deltaY<0?1.1:.9)},mousedown:function(t){0===t.button&&i(t,t.altKey?.8:1.2)}}}(),ui.resize(),ui.setBPM(120),ui.setClockTime(0),ui.setCursorTime(0),ui.setFilesWidth(200),ui.setTrackLinesLeft(0),ui.setTrackNamesWidth(125),ui.setGridZoom(1.5,0,0),ui.analyserToggle(!0),ui.toggleMagnetism(!0),ui.updateTrackLinesBg(),ui.jqBtnTools.filter("[data-tool='paint']").click();