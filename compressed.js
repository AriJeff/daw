"use strict";function walContext(){this.ctx=new window.AudioContext,this.destination=this.ctx.destination,this.filters=this.createFilters(),this.buffers=[],this.compositions=[],this.nbPlaying=0,this.filters.connect(this.destination),this.nodeIn=this.filters.nodeIn,delete this.filters.connect}!function(){function t(t){var e=keyboardRouter.defaultOptions,i=t.fn||e.fn,n={name:t.name,when:(t.when||e.when).toUpperCase(),preventDefault:void 0!==t.preventDefault?t.preventDefault:e.preventDefault,alt:!1,ctrl:!1,shift:!1,keys:[]};return n.fn=i.bind(t.thisArg||e.thisArg,t),t.keys.forEach(function(t){t=t.toUpperCase(),"ALT"===t?n.alt=!0:"CTRL"===t?n.ctrl=!0:"SHIFT"===t?n.shift=!0:n.keys.push(1===t.length?t.charCodeAt(0):keyboardRouter.keys[t])}),n}function e(){for(;o.length;){var t=o.pop();t.active&&(delete t.active,t.fn({type:"keyup"}))}}function i(t){var e=t.keyCode;s[e]||(s[e]=!0,a.some(function(i){if(!(i.active||t.altKey!==i.alt||t.ctrlKey!==i.ctrl||t.shiftKey!==i.shift||i.keys.length&&e!==i.keys[0])&&(i.fn(t),i.when.indexOf("UP")>-1&&(i.active=!0,o.push(i)),i.preventDefault!==!1))return t.preventDefault(),!0}))}function n(t){var e,i,n,a=t.keyCode,r=o.length;if(s[a]=!1,r){for(n=[],e=r-1;e>=0;--e)i=o[e],i.active&&(i.alt&&!t.altKey||i.ctrl&&!t.ctrlKey||i.shift&&!t.shiftKey||i.keys.length||a===i.keys[0])&&n.push(e);n.forEach(function(e){i=o[e],delete i.active,i.fn(t),o.splice(e,1)})}}var s=[],a=[],o=[];window.keyboardRouter=function(){for(var s=0,o=arguments.length;s<o;)a.push(t(arguments[s++]));document.body.addEventListener("keydown",i),document.body.addEventListener("keyup",n),window.addEventListener("blur",e)},keyboardRouter.defaultOptions={when:"down",fn:function(){},preventDefault:!0},keyboardRouter.keys={BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,CAPSLOCK:20,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,OS:91,CONTEXTMENU:93,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145}}(),function(){function t(t,e,i){return i||(i=e,e=document),t?n(e.querySelectorAll(i)):e.querySelector(i)}function e(t,e){var i,n=1,s=e.classList;for(aLen=arguments.length,lastArg=arguments[aLen-1],"boolean"==typeof lastArg&&(t=lastArg,--aLen);i=arguments[++n];)s.toggle(i,t)}function i(t,e){if(t){if(void 0===t.length)return e(t,0);for(var i,n,s=0;n=t[s];++s)if(void 0!==(i=e(n,s)))return i}}function n(t){return t.every=o,t.forEach=r,t.some=l,t}var s=window.wisdom={},a=[],o=a.every,r=a.forEach,l=a.some;s.querySelector=s.qS=t.bind(null,!1),s.querySelectorAll=s.qSA=t.bind(null,!0),s.createElement=s.cE=function(t){if("<"!==t[0])return document.createElement(t);var e=document.createElement("div");return e.innerHTML=t,n(e.children)},s.css=function(t,e,n){var s=arguments.length;return i(t,s>2?function(t){t.style[e]=n}:function(t){var i=getComputedStyle(t);return s>1?i[e]:i})},s.cLc=function(t,e){return t.classList.contains(e)},s.cLa=e.bind(null,!0),s.cLr=e.bind(null,!1),s.cLt=e.bind(null,void 0),s.classList={contains:s.cLc,add:s.cLa,remove:s.cLr,toggle:s.cLt}}(),!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Handlebars=e():t.Handlebars=e()}(this,function(){return function(t){function e(n){if(i[n])return i[n].exports;var s=i[n]={exports:{},id:n,loaded:!1};return t[n].call(s.exports,s,s.exports,e),s.loaded=!0,s.exports}var i={};return e.m=t,e.c=i,e.p="",e(0)}([function(t,e,i){function n(){var t=new r.HandlebarsEnvironment;return m.extend(t,r),t.SafeString=u.default,t.Exception=d.default,t.Utils=m,t.escapeExpression=m.escapeExpression,t.VM=h,t.template=function(e){return h.template(e,t)},t}var s=i(1).default,a=i(2).default;e.__esModule=!0;var o=i(3),r=s(o),l=i(17),u=a(l),c=i(5),d=a(c),f=i(4),m=s(f),p=i(18),h=s(p),g=i(19),v=a(g),w=n();w.create=n,v.default(w),w.default=w,e.default=w,t.exports=e.default},function(t,e){e.default=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e.default=t,e},e.__esModule=!0},function(t,e){e.default=function(t){return t&&t.__esModule?t:{default:t}},e.__esModule=!0},function(t,e,i){function n(t,e,i){this.helpers=t||{},this.partials=e||{},this.decorators=i||{},l.registerDefaultHelpers(this),u.registerDefaultDecorators(this)}var s=i(2).default;e.__esModule=!0,e.HandlebarsEnvironment=n;var a=i(4),o=i(5),r=s(o),l=i(6),u=i(14),c=i(16),d=s(c),f="4.0.5";e.VERSION=f;var m=7;e.COMPILER_REVISION=m;var p={1:"<= 1.0.rc.2",2:"== 1.0.0-rc.3",3:"== 1.0.0-rc.4",4:"== 1.x.x",5:"== 2.0.0-alpha.x",6:">= 2.0.0-beta.1",7:">= 4.0.0"};e.REVISION_CHANGES=p;var h="[object Object]";n.prototype={constructor:n,logger:d.default,log:d.default.log,registerHelper:function(t,e){if(a.toString.call(t)===h){if(e)throw new r.default("Arg not supported with multiple helpers");a.extend(this.helpers,t)}else this.helpers[t]=e},unregisterHelper:function(t){delete this.helpers[t]},registerPartial:function(t,e){if(a.toString.call(t)===h)a.extend(this.partials,t);else{if("undefined"==typeof e)throw new r.default('Attempting to register a partial called "'+t+'" as undefined');this.partials[t]=e}},unregisterPartial:function(t){delete this.partials[t]},registerDecorator:function(t,e){if(a.toString.call(t)===h){if(e)throw new r.default("Arg not supported with multiple decorators");a.extend(this.decorators,t)}else this.decorators[t]=e},unregisterDecorator:function(t){delete this.decorators[t]}};var g=d.default.log;e.log=g,e.createFrame=a.createFrame,e.logger=d.default},function(t,e){function i(t){return c[t]}function n(t){for(var e=1;e<arguments.length;e++)for(var i in arguments[e])Object.prototype.hasOwnProperty.call(arguments[e],i)&&(t[i]=arguments[e][i]);return t}function s(t,e){for(var i=0,n=t.length;n>i;i++)if(t[i]===e)return i;return-1}function a(t){if("string"!=typeof t){if(t&&t.toHTML)return t.toHTML();if(null==t)return"";if(!t)return t+"";t=""+t}return f.test(t)?t.replace(d,i):t}function o(t){return!t&&0!==t||!(!h(t)||0!==t.length)}function r(t){var e=n({},t);return e._parent=t,e}function l(t,e){return t.path=e,t}function u(t,e){return(t?t+".":"")+e}e.__esModule=!0,e.extend=n,e.indexOf=s,e.escapeExpression=a,e.isEmpty=o,e.createFrame=r,e.blockParams=l,e.appendContextPath=u;var c={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;","=":"&#x3D;"},d=/[&<>"'`=]/g,f=/[&<>"'`=]/,m=Object.prototype.toString;e.toString=m;var p=function(t){return"function"==typeof t};p(/x/)&&(e.isFunction=p=function(t){return"function"==typeof t&&"[object Function]"===m.call(t)}),e.isFunction=p;var h=Array.isArray||function(t){return!(!t||"object"!=typeof t)&&"[object Array]"===m.call(t)};e.isArray=h},function(t,e){function i(t,e){var s=e&&e.loc,a=void 0,o=void 0;s&&(a=s.start.line,o=s.start.column,t+=" - "+a+":"+o);for(var r=Error.prototype.constructor.call(this,t),l=0;l<n.length;l++)this[n[l]]=r[n[l]];Error.captureStackTrace&&Error.captureStackTrace(this,i),s&&(this.lineNumber=a,this.column=o)}e.__esModule=!0;var n=["description","fileName","lineNumber","message","name","number","stack"];i.prototype=new Error,e.default=i,t.exports=e.default},function(t,e,i){function n(t){o.default(t),l.default(t),c.default(t),f.default(t),p.default(t),g.default(t),w.default(t)}var s=i(2).default;e.__esModule=!0,e.registerDefaultHelpers=n;var a=i(7),o=s(a),r=i(8),l=s(r),u=i(9),c=s(u),d=i(10),f=s(d),m=i(11),p=s(m),h=i(12),g=s(h),v=i(13),w=s(v)},function(t,e,i){e.__esModule=!0;var n=i(4);e.default=function(t){t.registerHelper("blockHelperMissing",function(e,i){var s=i.inverse,a=i.fn;if(e===!0)return a(this);if(e===!1||null==e)return s(this);if(n.isArray(e))return e.length>0?(i.ids&&(i.ids=[i.name]),t.helpers.each(e,i)):s(this);if(i.data&&i.ids){var o=n.createFrame(i.data);o.contextPath=n.appendContextPath(i.data.contextPath,i.name),i={data:o}}return a(e,i)})},t.exports=e.default},function(t,e,i){var n=i(2).default;e.__esModule=!0;var s=i(4),a=i(5),o=n(a);e.default=function(t){t.registerHelper("each",function(t,e){function i(e,i,a){u&&(u.key=e,u.index=i,u.first=0===i,u.last=!!a,c&&(u.contextPath=c+e)),l+=n(t[e],{data:u,blockParams:s.blockParams([t[e],e],[c+e,null])})}if(!e)throw new o.default("Must pass iterator to #each");var n=e.fn,a=e.inverse,r=0,l="",u=void 0,c=void 0;if(e.data&&e.ids&&(c=s.appendContextPath(e.data.contextPath,e.ids[0])+"."),s.isFunction(t)&&(t=t.call(this)),e.data&&(u=s.createFrame(e.data)),t&&"object"==typeof t)if(s.isArray(t))for(var d=t.length;d>r;r++)r in t&&i(r,r,r===t.length-1);else{var f=void 0;for(var m in t)t.hasOwnProperty(m)&&(void 0!==f&&i(f,r-1),f=m,r++);void 0!==f&&i(f,r-1,!0)}return 0===r&&(l=a(this)),l})},t.exports=e.default},function(t,e,i){var n=i(2).default;e.__esModule=!0;var s=i(5),a=n(s);e.default=function(t){t.registerHelper("helperMissing",function(){if(1!==arguments.length)throw new a.default('Missing helper: "'+arguments[arguments.length-1].name+'"')})},t.exports=e.default},function(t,e,i){e.__esModule=!0;var n=i(4);e.default=function(t){t.registerHelper("if",function(t,e){return n.isFunction(t)&&(t=t.call(this)),!e.hash.includeZero&&!t||n.isEmpty(t)?e.inverse(this):e.fn(this)}),t.registerHelper("unless",function(e,i){return t.helpers.if.call(this,e,{fn:i.inverse,inverse:i.fn,hash:i.hash})})},t.exports=e.default},function(t,e){e.__esModule=!0,e.default=function(t){t.registerHelper("log",function(){for(var e=[void 0],i=arguments[arguments.length-1],n=0;n<arguments.length-1;n++)e.push(arguments[n]);var s=1;null!=i.hash.level?s=i.hash.level:i.data&&null!=i.data.level&&(s=i.data.level),e[0]=s,t.log.apply(t,e)})},t.exports=e.default},function(t,e){e.__esModule=!0,e.default=function(t){t.registerHelper("lookup",function(t,e){return t&&t[e]})},t.exports=e.default},function(t,e,i){e.__esModule=!0;var n=i(4);e.default=function(t){t.registerHelper("with",function(t,e){n.isFunction(t)&&(t=t.call(this));var i=e.fn;if(n.isEmpty(t))return e.inverse(this);var s=e.data;return e.data&&e.ids&&(s=n.createFrame(e.data),s.contextPath=n.appendContextPath(e.data.contextPath,e.ids[0])),i(t,{data:s,blockParams:n.blockParams([t],[s&&s.contextPath])})})},t.exports=e.default},function(t,e,i){function n(t){o.default(t)}var s=i(2).default;e.__esModule=!0,e.registerDefaultDecorators=n;var a=i(15),o=s(a)},function(t,e,i){e.__esModule=!0;var n=i(4);e.default=function(t){t.registerDecorator("inline",function(t,e,i,s){var a=t;return e.partials||(e.partials={},a=function(s,a){var o=i.partials;i.partials=n.extend({},o,e.partials);var r=t(s,a);return i.partials=o,r}),e.partials[s.args[0]]=s.fn,a})},t.exports=e.default},function(t,e,i){e.__esModule=!0;var n=i(4),s={methodMap:["debug","info","warn","error"],level:"info",lookupLevel:function(t){if("string"==typeof t){var e=n.indexOf(s.methodMap,t.toLowerCase());t=e>=0?e:parseInt(t,10)}return t},log:function(t){if(t=s.lookupLevel(t),"undefined"!=typeof console&&s.lookupLevel(s.level)<=t){var e=s.methodMap[t];console[e]||(e="log");for(var i=arguments.length,n=Array(i>1?i-1:0),a=1;i>a;a++)n[a-1]=arguments[a];console[e].apply(console,n)}}};e.default=s,t.exports=e.default},function(t,e){function i(t){this.string=t}e.__esModule=!0,i.prototype.toString=i.prototype.toHTML=function(){return""+this.string},e.default=i,t.exports=e.default},function(t,e,i){function n(t){var e=t&&t[0]||1,i=v.COMPILER_REVISION;if(e!==i){if(i>e){var n=v.REVISION_CHANGES[i],s=v.REVISION_CHANGES[e];throw new g.default("Template was precompiled with an older version of Handlebars than the current runtime. Please update your precompiler to a newer version ("+n+") or downgrade your runtime to an older version ("+s+").")}throw new g.default("Template was precompiled with a newer version of Handlebars than the current runtime. Please update your runtime to a newer version ("+t[1]+").")}}function s(t,e){function i(i,n,s){s.hash&&(n=p.extend({},n,s.hash),s.ids&&(s.ids[0]=!0)),i=e.VM.resolvePartial.call(this,i,n,s);var a=e.VM.invokePartial.call(this,i,n,s);if(null==a&&e.compile&&(s.partials[s.name]=e.compile(i,t.compilerOptions,e),a=s.partials[s.name](n,s)),null!=a){if(s.indent){for(var o=a.split("\n"),r=0,l=o.length;l>r&&(o[r]||r+1!==l);r++)o[r]=s.indent+o[r];a=o.join("\n")}return a}throw new g.default("The partial "+s.name+" could not be compiled when running in runtime-only mode")}function n(e){function i(e){return""+t.main(s,e,s.helpers,s.partials,o,l,r)}var a=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],o=a.data;n._setup(a),!a.partial&&t.useData&&(o=u(e,o));var r=void 0,l=t.useBlockParams?[]:void 0;return t.useDepths&&(r=a.depths?e!==a.depths[0]?[e].concat(a.depths):a.depths:[e]),(i=c(t.main,i,s,a.depths||[],o,l))(e,a)}if(!e)throw new g.default("No environment passed to template");if(!t||!t.main)throw new g.default("Unknown template object: "+typeof t);t.main.decorator=t.main_d,e.VM.checkRevision(t.compiler);var s={strict:function(t,e){if(!(e in t))throw new g.default('"'+e+'" not defined in '+t);return t[e]},lookup:function(t,e){for(var i=t.length,n=0;i>n;n++)if(t[n]&&null!=t[n][e])return t[n][e]},lambda:function(t,e){return"function"==typeof t?t.call(e):t},escapeExpression:p.escapeExpression,invokePartial:i,fn:function(e){var i=t[e];return i.decorator=t[e+"_d"],i},programs:[],program:function(t,e,i,n,s){var o=this.programs[t],r=this.fn(t);return e||s||n||i?o=a(this,t,r,e,i,n,s):o||(o=this.programs[t]=a(this,t,r)),o},data:function(t,e){for(;t&&e--;)t=t._parent;return t},merge:function(t,e){var i=t||e;return t&&e&&t!==e&&(i=p.extend({},e,t)),i},noop:e.VM.noop,compilerInfo:t.compiler};return n.isTop=!0,n._setup=function(i){i.partial?(s.helpers=i.helpers,s.partials=i.partials,s.decorators=i.decorators):(s.helpers=s.merge(i.helpers,e.helpers),t.usePartial&&(s.partials=s.merge(i.partials,e.partials)),(t.usePartial||t.useDecorators)&&(s.decorators=s.merge(i.decorators,e.decorators)))},n._child=function(e,i,n,o){if(t.useBlockParams&&!n)throw new g.default("must pass block params");if(t.useDepths&&!o)throw new g.default("must pass parent depths");return a(s,e,t[e],i,0,n,o)},n}function a(t,e,i,n,s,a,o){function r(e){var s=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=o;return o&&e!==o[0]&&(r=[e].concat(o)),i(t,e,t.helpers,t.partials,s.data||n,a&&[s.blockParams].concat(a),r)}return r=c(i,r,t,o,n,a),r.program=e,r.depth=o?o.length:0,r.blockParams=s||0,r}function o(t,e,i){return t?t.call||i.name||(i.name=t,t=i.partials[t]):t="@partial-block"===i.name?i.data["partial-block"]:i.partials[i.name],t}function r(t,e,i){i.partial=!0,i.ids&&(i.data.contextPath=i.ids[0]||i.data.contextPath);var n=void 0;if(i.fn&&i.fn!==l&&(i.data=v.createFrame(i.data),n=i.data["partial-block"]=i.fn,n.partials&&(i.partials=p.extend({},i.partials,n.partials))),void 0===t&&n&&(t=n),void 0===t)throw new g.default("The partial "+i.name+" could not be found");return t instanceof Function?t(e,i):void 0}function l(){return""}function u(t,e){return e&&"root"in e||(e=e?v.createFrame(e):{},e.root=t),e}function c(t,e,i,n,s,a){if(t.decorator){var o={};e=t.decorator(e,o,i,n&&n[0],s,a,n),p.extend(e,o)}return e}var d=i(1).default,f=i(2).default;e.__esModule=!0,e.checkRevision=n,e.template=s,e.wrapProgram=a,e.resolvePartial=o,e.invokePartial=r,e.noop=l;var m=i(4),p=d(m),h=i(5),g=f(h),v=i(3)},function(t,e){(function(i){e.__esModule=!0,e.default=function(t){var e="undefined"!=typeof i?i:window,n=e.Handlebars;t.noConflict=function(){return e.Handlebars===t&&(e.Handlebars=n),t}},t.exports=e.default}).call(e,function(){return this}())}])}),function(){var t=Handlebars.template,e=Handlebars.templates=Handlebars.templates||{};e.clock=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){return'<div id="clock">\r\n\t<span id="clockMin"></span>\r\n\t<span id="clockSec"></span>\r\n\t<span id="clockMs"></span>\r\n\t<a id="clockUnits" href="#">\r\n\t\t<span class="s">sec</span>\r\n\t\t<span class="b">beat</span>\r\n\t</a>\r\n</div>\r\n'},useData:!0}),e.file=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return'<a class="sample" draggable="true">\r\n\t<div class="waveformWrapper">\r\n\t\t<svg class="waveform" preserveAspectRatio="none"><path/></svg>\r\n\t</div>\r\n\t<span class="name text-overflow">\r\n\t\t<i class="icon fw"></i>\r\n\t\t<span>'+t.escapeExpression((a=null!=(a=i.name||(null!=e?e.name:e))?a:i.helperMissing,"function"==typeof a?a.call(null!=e?e:{},{name:"name",hash:{},data:s}):a))+"</span>\r\n\t</span>\r\n</a>\r\n"},useData:!0}),e.grid=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return'<div id="grid">\r\n\t<div id="gridEm">\r\n\t\t<div id="gridHeader">\r\n'+(null!=(a=t.invokePartial(n.timeline,e,{name:"timeline",data:s,indent:"\t\t\t",helpers:i,partials:n,decorators:t.decorators}))?a:"")+'\t\t</div>\r\n\t\t<div id="tracks">\r\n\t\t\t<div id="gridCols">\r\n\t\t\t\t<div id="tracksNames" class="colA">\r\n\t\t\t\t\t<div class="extend" data-mousemove-fn="trackNames"></div>\r\n\t\t\t\t</div>\r\n\t\t\t\t<div id="gridColB">\r\n\t\t\t\t\t<div id="tracksBg"></div>\r\n\t\t\t\t\t<div id="tracksLines">\r\n\t\t\t\t\t\t<div id="currentTimeCursor"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t</div>\r\n</div>\r\n'},usePartial:!0,useData:!0}),e.historyAction=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a,o,r=null!=e?e:{},l=i.helperMissing,u="function",c=t.escapeExpression;return'<a class="task">\r\n\t<i class="icon fw circle"></i\r\n\t><i class="icon fw tool tool-'+c((o=null!=(o=i.name||(null!=e?e.name:e))?o:l,typeof o===u?o.call(r,{name:"name",hash:{},data:s}):o))+'"></i\r\n\t><b class="title">'+c((o=null!=(o=i.name||(null!=e?e.name:e))?o:l,typeof o===u?o.call(r,{name:"name",hash:{},data:s}):o))+'</b\r\n\t><span class="text">'+(null!=(o=null!=(o=i.desc||(null!=e?e.desc:e))?o:l,a=typeof o===u?o.call(r,{name:"desc",hash:{},data:s}):o)?a:"")+"</span>\r\n</a>\r\n"},useData:!0}),e.menu=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){return'<div id="menu">\r\n\t<a id="btnPlay" class="btn border icon play" title="Play/pause (press Space, hold Ctrl for pause)"></a>\r\n\t<a id="btnStop" class="btn border icon stop" title="Stop (press Space)"></a>\r\n\t<div id="bpm" class="border" title="Beats per minute (Scroll to change)">\r\n\t\t<span class="text">\r\n\t\t\t<a class="bpmLink">\r\n\t\t\t\t<i class="icon"></i>\r\n\t\t\t\t<span id="bpmInt"></span>\r\n\t\t\t\t<span id="bpmDec"></span>\r\n\t\t\t</a>\r\n\t\t\t<div id="bpmList">\r\n\t\t\t\t<a>80</a><a>90</a><a>100</a>\r\n\t\t\t\t<a>110</a><a>120</a><a>130</a>\r\n\t\t\t\t<a>140</a><a>150</a><a>160</a>\r\n\t\t\t</div>\r\n\t\t\t<span class="unit">bpm</span>\r\n\t\t</span>\r\n\t</div>\r\n\t<a data-edit="save"     id="btnSave"   class="btn icon fw save" title="Save"></a>\r\n\t<a data-option="magnet" id="btnMagnet" class="btn icon fw magnet" title="Toggle magnetism (press G)"></a>\r\n\t<div class="sep"></div>\r\n\t<a data-tool="select" class="btn icon fw tool-select" title="Select (hold Shift or press V)"></a>\r\n\t<a data-tool="paint"  class="btn icon fw tool-paint" title="Paint (press B)"></a>\r\n\t<a data-tool="delete" class="btn icon fw tool-delete" title="Delete (press D)"></a>\r\n\t<a data-tool="mute"   class="btn icon fw tool-mute" title="Mute (press M)" style="display: none;"></a>\r\n\t<a data-tool="slip"   class="btn icon fw tool-slip" title="Slip (press S)"></a>\r\n\t<a data-tool="cut"    class="btn icon fw tool-cut" title="Cut (press C)"></a>\r\n\t<a data-tool="hand"   class="btn icon fw tool-hand" title="Hand (hold Alt or press H)"></a>\r\n\t<a data-tool="zoom"   class="btn icon fw tool-zoom last" title="Zoom (hold Ctrl or press Z)"></a>\r\n\t<div class="flex1"></div>\r\n\t<a href=".." target="_blank" class="icon about" title="About"></a>\r\n</div>\r\n'},useData:!0}),e["panel-files"]=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){return'<section id="files">\r\n\t<input id="filesInput" type="file"/>\r\n\t<nav id="filesFilters">\r\n\t\t<a href="#" class="used">Used</a>\r\n\t\t<a href="#" class="loaded">Loaded</a>\r\n\t\t<a href="#" class="unloaded">Unloaded</a>\r\n\t</nav>\r\n\t<div id="filesList" class="list"></div>\r\n\t<div class="placeholder">\r\n\t\t<i class="icon file-audio"></i><br/>\r\n\t\t<b>Drop audio files here</b>\r\n\t</div>\r\n</section>\r\n'},useData:!0}),e["panel-history"]=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){return'<section id="history">\r\n\t<nav>\r\n\t\t<span class="title">History</span>\r\n\t\t<a id="btnUndo" class="btn icon fw undo" title="Undo (Ctrl + Z)"></a>\r\n\t\t<a id="btnRedo" class="btn icon fw redo" title="Redo (Ctrl + Shift + Z)"></a>\r\n\t</nav>\r\n\t<div id="historyList" class="list"></div>\r\n</section>\r\n'},useData:!0}),e.panel=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return'<div id="panel">\r\n\t<div class="extend" data-mousemove-fn="panel"></div>\r\n'+(null!=(a=t.invokePartial(n["panel-history"],e,{name:"panel-history",data:s,indent:"\t",helpers:i,partials:n,decorators:t.decorators}))?a:"")+(null!=(a=t.invokePartial(n["panel-files"],e,{name:"panel-files",data:s,indent:"\t",helpers:i,partials:n,decorators:t.decorators}))?a:"")+"</div>\r\n"},usePartial:!0,useData:!0}),e.sample=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return'<div class="sample">\r\n\t<div class="waveformWrapper">\r\n\t\t<svg class="waveform" preserveAspectRatio="none"><path/></svg>\r\n\t</div>\r\n\t<span class="name text-overflow">'+t.escapeExpression((a=null!=(a=i.name||(null!=e?e.name:e))?a:i.helperMissing,"function"==typeof a?a.call(null!=e?e:{},{name:"name",hash:{},data:s}):a))+'</span>\r\n\t<div class="crop start"></div>\r\n\t<div class="crop end"></div>\r\n</div>\r\n'},useData:!0}),e.timeline=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return'<div id="timeline">\r\n\t<span id="currentTimeArrow" class="icon caret-down"></span>\r\n'+(null!=(a=t.invokePartial(n.timelineLoop,e,{name:"timelineLoop",data:s,indent:"\t",helpers:i,partials:n,decorators:t.decorators}))?a:"")+'\t<div id="timelineBeats"></div>\r\n</div>\r\n'},usePartial:!0,useData:!0}),e.timelineBeat=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){return'<span class="timelineBeat">\r\n\t<span></span>\r\n</span>\r\n'},useData:!0}),e.timelineLoop=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){return'<div id="timelineLoop">\r\n\t<div class="time a"></div>\r\n\t<div class="time b"></div>\r\n</div>\r\n'},useData:!0}),e.visual=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return'<div id="visual">\r\n\t<canvas id="visualCanvas"></canvas>\r\n\t<div class="columns">\r\n\t\t<div class="cell-btn"><a id="btnHistory" class="btn icon fw history" title="History (undo/redo)"></a></div>\r\n\t\t<div class="cell-btn"><a id="btnFiles" class="btn icon fw files" title="Audio files"></a></div>\r\n\t\t<div class="cell-clock">\r\n'+(null!=(a=t.invokePartial(n.clock,e,{name:"clock",data:s,indent:"\t\t\t",helpers:i,partials:n,decorators:t.decorators}))?a:"")+"\t\t</div>\r\n\t</div>\r\n</div>\r\n"},usePartial:!0,useData:!0}),e._app=t({compiler:[7,">= 4.0.0"],main:function(t,e,i,n,s){var a;return(null!=(a=t.invokePartial(n.visual,e,{name:"visual",data:s,helpers:i,partials:n,decorators:t.decorators}))?a:"")+(null!=(a=t.invokePartial(n.menu,e,{name:"menu",data:s,helpers:i,partials:n,decorators:t.decorators}))?a:"")+(null!=(a=t.invokePartial(n.panel,e,{name:"panel",data:s,helpers:i,partials:n,decorators:t.decorators}))?a:"")+(null!=(a=t.invokePartial(n.grid,e,{name:"grid",data:s,helpers:i,partials:n,decorators:t.decorators}))?a:"")},usePartial:!0,useData:!0})}(),window.AudioContext=window.AudioContext||window.webkitAudioContext,walContext.prototype={gain:function(t){return arguments.length?(this.filter.gain(t),this):this.filter.gain()},createSample:function(){return new walContext.Sample(this)},createBuffer:function(t){var e=this;return new Promise(function(i,n){new walContext.Buffer(e,t,i,n)}).then(function(t){return e.buffers.push(t),t})},createFilters:function(){return new walContext.Filters(this)},createComposition:function(){var t=new walContext.Composition(this);return this.compositions.push(t),t}},function(){function t(t){this.samples.indexOf(t)<0&&(this.samples.push(t),t.composition=this,this.update(t,"ad"))}function e(t){var e=this.samples.indexOf(t);e>-1&&(t.composition=null,this.samples.splice(e,1),this.update(t,"rm"))}function i(t){clearTimeout(t.playTimeoutId),t.samples.forEach(function(t){t.stop()})}function n(t){var e=t.currentTime();t.samples.forEach(function(t){u(t)>e&&t.load()})}function s(t){var e=t.currentTime();t.samples.forEach(function(t){u(t)>e&&l(t,e)}),o(t)}function a(t){var e=t.samples[t.samples.length-1]||null,i=e?u(e):0;t.lastSample=e,Math.abs(t.duration-i)>.001&&(t.duration=i,o(t))}function o(t){var e=t.duration-t.currentTime();clearTimeout(t.playTimeoutId),e<=0?t.onended():t.playTimeoutId=setTimeout(t.onended.bind(t),1e3*e)}function r(t,e,i){var n=t.currentTime();u(e)>n&&"rm"!==i&&(e.load(),l(e,n))}function l(t,e){var i=t.when-e;t.start(i,i>0?t.offset:t.offset-i,i>0?t.duration:t.duration+i)}function u(t){return t.when+t.duration}walContext.Composition=function(t){this.wCtx=t,this.samples=[],this.lastSample=null,this.isPlaying=this.isPaused=!1,this.duration=this._startedTime=this._currentTime=0,this.fnOnended=this.fnOnpaused=function(){}},walContext.Composition.prototype={add:function(e){return e.forEach?e.forEach(t,this):t.call(this,e),this},remove:function(t){return t.forEach?t.forEach(e,this):e.call(this,t),this},update:function(t,e){var i,n=this;return"rm"!==e&&this.samples.sort(function(t,e){return t.when<e.when?-1:t.when>e.when?1:0}),a(this),this.isPlaying&&(t.started?(i=t._onendedFn,t.onended(function(){r(n,t,e),t.onended(i),i()}),t.stop()):r(this,t,e)),this},currentTime:function(t){return arguments.length?(this.isPlaying&&i(this),this._currentTime=Math.max(0,Math.min(t,this.duration)),this.isPlaying&&(this._startedTime=this.wCtx.ctx.currentTime,n(this),s(this)),this):this._currentTime+(this.isPlaying&&this.wCtx.ctx.currentTime-this._startedTime)},play:function(){return this.isPlaying||(this.isPlaying=!0,this.isPaused=!1,this._startedTime=this.wCtx.ctx.currentTime,n(this),s(this)),this},stop:function(){return(this.isPlaying||this.isPaused)&&(i(this),this.onended()),this},pause:function(){return this.isPlaying&&(this.isPlaying=!1,this.isPaused=!0,this._currentTime+=this.wCtx.ctx.currentTime-this._startedTime,this._startedTime=0,i(this),this.fnOnpaused()),this},onended:function(t){return"function"==typeof t?this.fnOnended=t:(this.isPlaying=this.isPaused=!1,this._startedTime=this._currentTime=0,this.fnOnended()),this}}}(),function(){walContext.Buffer=function(t,e,i,n){function s(t){a.wCtx.ctx.decodeAudioData(t,function(t){a.buffer=t,a.isReady=!0,i(a)},n)}var a=this,o=new FileReader;this.wCtx=t,this.isReady=!1,e.name?(o.addEventListener("loadend",function(){s(o.result)}),o.readAsArrayBuffer(e)):s(e)},walContext.Buffer.prototype={getPeaks:function(t,e,i,n){i=i||0,n=void 0===n?this.buffer.duration-i:Math.min(n,this.buffer.duration-i);for(var s,a,o,r=0,l=new Array(e),u=this.buffer.getChannelData(t),c=n*this.buffer.sampleRate,d=i*this.buffer.sampleRate,f=c/e,m=~~Math.max(1,f/10);r<e;++r){for(s=d+r*f,a=s+f,o=0;s<a;s+=m)o=Math.max(o,Math.abs(u[~~s]));l[r]=o}return l}}}(),function(){function t(t,e,i){t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3]}function e(e,i,n,s){var a,o,r,l,u=i.data,c=i.width,d=i.height,f=d/2,m=e.getPeaks(0,c),p=e.buffer.numberOfChannels>1?e.getPeaks(1,c):m;if(s){for(a=0;a<u.length;a+=4)t(u,a,n);n=[0,0,0,0]}for(a=0;a<c;++a){for(r=~~(f*(1-m[a])),l=~~(f*(1+p[a])),o=r;o<=l;++o)t(u,4*(o*c+a),n);t(u,4*(f*c+a),n)}return i}walContext.Buffer.prototype.waveformSVG=function(t,e,i,n,s){var a,o=i/2-.5,r=i/2+.5,l="M0 "+o,u=t?t.firstChild:document.createElement("path"),c=this.getPeaks(0,e,n,s),d=this.buffer.numberOfChannels>1?this.getPeaks(1,e,n,s):c;for(t||(t=document.createElement("svg"),t.appendChild(u)),a=0;a<e;++a)l+=" L"+a+" "+(o-c[a]*o);for(a=e-1;a>=0;--a)l+=" L"+a+" "+(r+d[a]*o);return u.setAttribute("d",l),t.setAttribute("viewBox","0 0 "+e+" "+i),t},walContext.Buffer.prototype.drawWaveform=function(t,i){return e(this,t,i)},walContext.Buffer.prototype.drawInvertedWaveform=function(t,i){return e(this,t,i,!0)}}(),walContext.Filters=function(t){this.wCtx=t,this.nodes=[],this.nodeIn=t.ctx.createGain(),this.nodeOut=t.ctx.createGain(),this.nodeIn.connect(this.nodeOut),this.connect(t)},walContext.Filters.prototype={connect:function(t){t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.nodeOut.connect(t))},disconnect:function(){this.nodeOut.disconnect(),this.connectedTo=null},empty:function(){this.nodes.length&&(this.nodes[this.nodes.length-1].disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut),this.nodes=[])},gain:function(t){return arguments.length?void(this.nodeOut.gain.value=t):this.nodeOut.gain.value},pushBack:function(t){if(this.nodes.length){var e=this.nodes[this.nodes.length-1];e.disconnect(),e.connect(t)}else this.nodeIn.disconnect(),this.nodeIn.connect(t);t.connect(this.nodeOut),this.nodes.push(t)},pushFront:function(t){this.nodes.length?(this.nodeIn.disconnect(),this.nodeIn.connect(t),t.connect(this.nodes[0]),this.nodes.unshift(t)):this.pushBack(t)},popBack:function(){var t=this.nodes.pop();if(t)if(t.disconnect(),this.nodes.length){var e=this.nodes[this.nodes.length-1];e.disconnect(),e.connect(this.nodeOut)}else this.nodeIn.disconnect(),this.nodeIn.connect(this.nodeOut);return t},popFront:function(){var t=this.nodes.shift();return t&&(t.disconnect(),this.nodeIn.disconnect(),this.nodeIn.connect(this.nodes[0]||this.nodeOut)),t}},walContext.Sample=function(t){this.wCtx=t,this.connectedTo=t.nodeIn,this.loaded=this.started=this.playing=!1,this._onendedFn=function(){},this.onplay=this.onplay.bind(this),this.onended=this.onended.bind(this),this.edit(0,0)},walContext.Sample.prototype={setBuffer:function(t){return this.wBuffer=t,this.setBufferDuration(t.buffer.duration)},setBufferDuration:function(t){return this.bufferDuration=t,(null==this.duration||this.duration>t)&&(this.duration=t),this},edit:function(t,e,i){return null!=t&&(this.when=t),null!=e&&(this.offset=e),null!=i&&(this.duration=i),this},connect:function(t){return t=t.nodeIn||t,t instanceof AudioNode&&(this.connectedTo=t,this.source&&this.source.connect(t)),this},disconnect:function(){return this.source&&(this.source.disconnect(),this.connectedTo=null),this},load:function(){return this.wBuffer&&!this.loaded&&(this.loaded=!0,this.source=this.wCtx.ctx.createBufferSource(),this.source.buffer=this.wBuffer.buffer,this.source.onended=this.onended,this.connectedTo&&this.source.connect(this.connectedTo)),this},start:function(t,e,i){return this.loaded&&!this.started&&(t=null!=t?t:this.when,e=null!=e?e:this.offset,i=null!=i?i:this.duration,this.source.start(this.wCtx.ctx.currentTime+t,e,i),this.started=!0,t?this.playTimeoutId=setTimeout(this.onplay,1e3*t):this.onplay()),this},stop:function(){return this.started&&(this.source.onended=null,this.source.stop(0),this.onended()),this},onplay:function(){this.playing=!0,++this.wCtx.nbPlaying},onended:function(t){return"function"==typeof t?this._onendedFn=t:this.loaded&&(this.started&&(this.started=!1,clearTimeout(this.playTimeoutId)),this.playing&&(this.playing=!1,--this.wCtx.nbPlaying),this.loaded=!1,this.source=null,this._onendedFn()),this}},window.gs={sample:{},files:[],selectedSamples:[]},function(){var t,e,i;gs.loop=t={reorderTimeAB:function(){if(e>i){var t=e;e=i,i=t}},timeA:function(i){lg("timea"),e=i,t.update()},timeB:function(e){lg("timeb"),i=e,t.update()},stop:function(){e=i=void 0,ui.timelineLoop.toggle(!1)},update:function(){var t,n,s=Math.abs(i-e);isNaN(s)||(n=Math.min(e,i),t=s>.01,t&&(ui.timelineLoop.when(n),ui.timelineLoop.duration(s)),ui.timelineLoop.toggle(t))}}}(),gs.playStop=function(){(gs.isPlaying?gs.stop:gs.play)()},gs.playPause=function(){(wa.composition.isPlaying?gs.pause:gs.play)()},gs.play=function(){gs.fileStop(),!wa.composition.isPlaying&&wa.composition.samples.length&&(wa.composition.play(),
wa.composition.isPlaying&&(gs.isPaused=!(gs.isPlaying=!0),ui.btnPlay.play()))},gs.pause=function(){gs.fileStop(),wa.composition.isPlaying&&(wa.composition.pause(),gs.isPaused=!(gs.isPlaying=!1),ui.btnPlay.pause())},gs.stop=function(){gs.fileStop(),gs.compositionStop()},gs.compositionStop=function(){wa.composition.stop(),gs.currentTime(0),gs.isPaused=gs.isPlaying=!1,ui.btnStop.stop()},function(){gs.history={goToAction:function(t){var i=t.id-e+1;if(i<0)for(;i++;)gs.history.undo();else if(i>0)for(;i--;)gs.history.redo()},push:function(i,n){var s={id:e,name:i,fn:gs.history[i],data:n};e<t.length-1&&t.splice(e+1),t.push(s),ui.historyList.push(s),++e},undo:function(){if(e>0){var i=t[e--];i.fn&&i.fn(i.data,-1),ui.historyList.undo()}},redo:function(){if(e<t.length-1){var i=t[++e];i.fn&&i.fn(i.data,1),ui.historyList.redo()}}};var t=[{}],e=0}(),function(){function t(t){t.samples.forEach(function(t){gs.sample.select(t)})}function e(t,e){return e===-1?i(t,1):void t.samples.forEach(function(t){wa.composition.add(t),ui.CSS_sampleCreate(t),gs.sample.inTrack(t,t.data.oldTrack.id),gs.sample.when(t,t.when),gs.sample.duration(t,t.duration),gs.sample.slip(t,t.offset),gs.sample.select(t,t.data.oldSelected),t.data.gsfile.nbSamples++||ui.CSS_fileUsed(t.data.gsfile)})}function i(t,i){i===-1?e(t,1):t.samples.forEach(gs.sample.delete)}function n(t,e){var i=t.sample,n=t.track*e;gs.samplesWhen(i,t.when*e),n&&(i.data.selected?gs.selectedSamples.forEach(function(t){gs.sample.inTrack(t,t.data.track.id+n)}):gs.sample.inTrack(i,i.data.track.id+n)),gs.samplesForEach(i,function(t){wa.composition.update(t,"mv")})}function s(t,e){var i=t.sample;gs.samplesDuration(i,t.duration*e),gs.samplesWhen(i,t.when*e),gs.samplesSlip(i,-t.offset*e),gs.samplesForEach(i,function(t){wa.composition.update(t,"mv")})}function a(t,e){gs.samplesDuration(t.sample,t.duration*e),gs.samplesForEach(t.sample,function(t){wa.composition.update(t,"mv")})}function o(t,e){gs.samplesSlip(t.sample,t.offset*e),gs.samplesForEach(t.sample,function(t){wa.composition.update(t,"mv")})}Object.assign(gs.history,{select:t,insert:e,delete:i,move:n,crop:s,cropEnd:a,slip:o})}(),function(){var t=[],e="click mousedown mouseup mousemove".split(" ");window.ui={dom:{},initElement:function(e,i){return t.push({name:e,fn:i}),ui},init:function(i,n,s){function a(t){t.id&&(ui.dom[t.id]=t)}var o,r=Handlebars.templates;for(o in r)o!==n&&Handlebars.registerPartial(o,r[o]);i.innerHTML=r[n](s),function t(e){for(var i,n=e.firstChild;null!==n;)t(i=n),n=n.nextSibling,1!==i.nodeType&&/^\s*$/.test(i.textContent)&&e.removeChild(i)}(i),a(i),Array.from(i.querySelectorAll("[id]")).forEach(a),t.forEach(function(t){var i,n=ui.dom[t.name],s=t.fn(n);ui[t.name]=s;for(i in s)e.indexOf(i)>-1&&n.addEventListener(i,s[i])})}}}(),ui.isMagnetized=!1,ui.initElement("btnMagnet",function(t){function e(e){"boolean"!=typeof e&&(e=!ui.isMagnetized),ui.isMagnetized=e,t.classList.toggle("active",e)}return{click:e,toggle:e}}),ui.initElement("btnPlay",function(t){function e(){var t=wa.composition.currentTime();ui.currentTimeCursor.at(t),ui.clock.setTime(t),i=requestAnimationFrame(e)}var i;return{click:gs.playPause,play:function(){t.classList.remove("play"),t.classList.add("pause"),e()},pause:function(){cancelAnimationFrame(i),t.classList.remove("pause"),t.classList.add("play")}}}),ui.initElement("btnSave",function(t){return{click:function(){var e=gs.save();t.setAttribute("href",e.href),t.setAttribute("download",e.download)}}}),ui.initElement("btnStop",function(t){return{click:gs.stop,stop:function(){ui.btnPlay.pause(),ui.currentTimeCursor.at(0),ui.clock.setTime(0)}}}),ui.initElement("btnUndo",function(){return{click:gs.history.undo}}),ui.initElement("btnRedo",function(){return{click:gs.history.redo}}),ui.initElement("clock",function(t){return{setUnit:function(t){var e=gs.currentTime();ui.dom.clockUnits.dataset.unit=t,ui.currentTimeCursor.at(e),ui.clock.setTime(e)},setTime:function(t){var e,i,n;"s"===gs.clockUnit?(e=~~(t/60),i=~~(t%60)):(t*=ui.BPMem,e=1+~~t,t*=4,i=1+~~t%4),i=i<10?"0"+i:i,n=Math.floor(1e3*(t-~~t)),n<10?n="00"+n:n<100&&(n="0"+n),ui.dom.clockMin.textContent=e,ui.dom.clockSec.textContent=i,ui.dom.clockMs.textContent=n}}}),ui.initElement("currentTimeCursor",function(t){var e=ui.dom.currentTimeArrow;return{at:function(i){if(i>0){var n=i*ui.BPMem+"em";wisdom.css(t,"left",n),wisdom.css(e,"left",n)}t.classList.toggle("visible",i>0),e.classList.toggle("visible",i>0)}}}),ui.initElement("historyList",function(t){var e,i;return{click:function(t){(t=t.target.historyAction)&&gs.history.goToAction(t)},reset:function(){for(e=0,i=[];t.hasChildNodes();)t.lastChild.remove()},undo:function(){i[--e].classList.add("undone")},redo:function(){i[e++].classList.remove("undone")},push:function(n){for(var s=i.length-e,a=wisdom.cE(Handlebars.templates.historyAction(n))[0];s-- >0;)i.pop().remove();e++,a.historyAction=n,i.push(a),t.appendChild(a),t.scrollTop=1e9}}}),ui.initElement("timeline",function(){var t;return{mousedown:function(e){var i=Date.now();i-t<250&&(gs.loop.stop(),gs.loop.timeA(ui.getGridSec(e.pageX)),ui.timelineLoop.clickTime("b")),t=i},mouseup:function(t){ui.timelineLoop.dragging||gs.currentTime(ui.getGridSec(t.pageX))},update:function(){var t=ui.trackLinesLeft/ui.gridEm,e=ui.trackLinesWidth/ui.gridEm;ui.timelineBeats.fill(Math.ceil(-t+e)),ui.dom.timelineBeats.style.marginLeft=t+="em",ui.dom.currentTimeArrow.style.marginLeft=t,ui.dom.timelineLoop.style.marginLeft=t}}}),ui.initElement("timelineBeats",function(t){var e=0;return{fill:function(i){if(i>e){var n=e;for(e=i;n++<i;)t.appendChild(wisdom.cE(Handlebars.templates.timelineBeat())[0])}}}}),ui.initElement("timelineLoop",function(t){var e,i;return document.body.addEventListener("mousemove",function(t){i&&i(ui.getGridSec(t.pageX))}),document.body.addEventListener("mouseup",function(){i&&(i=null,e.dragging=!1,ui.cursor("app",null))}),e={mousedown:function(t){var i=t.target;i.classList.contains("time")&&(e.clickTime(i.classList.contains("a")?"a":"b"),t.stopPropagation())},clickTime:function(t){i="a"===t?gs.loop.timeA:gs.loop.timeB,gs.loop.reorderTimeAB(),e.dragging=!0,ui.cursor("app","w-resize")},toggle:function(e){t.classList.toggle("hidden",!e)},when:function(e){t.style.left=e*ui.BPMem+"em"},duration:function(e){t.style.width=e*ui.BPMem+"em"}}}),ui.initElement("tracksBg",function(t){function e(e){var s,a,o,r,l,u=e-n;for(n=Math.max(e,n),s=0;s<u;++s){for(r=document.createElement("div"),a=0;a<4;++a){for(l=document.createElement("div"),o=0;o<4;++o)l.appendChild(document.createElement("div"));r.appendChild(l)}t.appendChild(r)}i=i||t.firstChild}var i,n=0;return{update:function(){e(Math.ceil(ui.trackLinesWidth/ui.gridEm/4)+2),wisdom.css(i,"marginLeft",ui.trackLinesLeft/ui.gridEm%8+"em")}}}),ui.initElement("visualCanvas",function(t){function e(){var a=n;wa.wctx.nbPlaying&&(a=wa.analyserArray,wa.analyser.getByteTimeDomainData(a)),wa.oscilloscope(t,s,a),i=requestAnimationFrame(e)}var i,n=[],s=t.getContext("2d");return{on:function(){i=requestAnimationFrame(e)},off:function(){cancelAnimationFrame(i),s.clearRect(0,0,t.width,t.height)}}}),ui.init(wisdom.qS("#app"),"_app",{}),ui.dom.toolBtns=wisdom.qSA(ui.dom.menu,".btn[data-tool]"),ui.tool={},ui.tracks=[],ui.nbTracksOn=0,ui.gridEm=parseFloat(getComputedStyle(ui.dom.grid).fontSize),ui.gridColsY=ui.dom.gridCols.getBoundingClientRect().top,ui.dom.visualCanvas.width=256,ui.dom.visualCanvas.height=ui.dom.visualCanvas.clientHeight,ui.bpm=function(t){var e=~~t,i=Math.min(Math.round(100*(t-e)),99);ui._bpm=t,ui.dom.bpmInt.textContent=e<100?"0"+e:e,ui.dom.bpmDec.textContent=i<10?"0"+i:i},function(){function t(t,e){e?t.dataset.cursor=e:t.removeAttribute("data-cursor")}var e=null;ui.cursor=function(i,n){"app"===i?(t(ui.dom.app,n),t(ui.dom.tracksLines,n?null:e)):t(ui.dom.tracksLines,e=n)}}(),function(){function t(t,e){return Math.abs(t-e)<1e-4}function e(t){var e=t%i;return t-=e,e>n&&(t+=i),t}ui.getGridSec=function(t){var i=(t-ui.filesWidth-ui.trackNamesWidth-ui.trackLinesLeft)/ui.gridEm;return(ui.isMagnetized?e(i):i)/ui.BPMem},ui.secFloor=function(n){var s=n*ui.BPMem,a=e(s);return(a<s||t(a,s)?a:a-i)/ui.BPMem},ui.secCeil=function(n){var s=n*ui.BPMem,a=e(s);return(a>s||t(a,s)?a:a+i)/ui.BPMem};var i=.25,n=i/2}(),ui.getTrackFromPageY=function(t){return ui.tracks[Math.floor((t-ui.gridColsY+ui.gridScrollTop)/ui.gridEm)]},ui.CSS_fileUnloaded=function(t){t.elIcon.classList.add("ramload"),t.elIcon.classList.remove("question"),t.elFile.classList.add("unloaded")},ui.CSS_fileWithoutData=function(t){t.elIcon.classList.add("question"),t.elIcon.classList.remove("ramload"),t.elFile.classList.add("unloaded")},ui.CSS_fileLoading=function(t){t.elIcon.classList.add("loading"),t.elIcon.classList.remove("ramload")},ui.CSS_fileLoaded=function(t){t.elFile.classList.add("loaded"),t.elFile.classList.remove("unloaded"),t.elIcon.remove()},ui.CSS_fileError=function(t){t.elIcon.classList.add("cross"),t.elIcon.classList.remove("loading")},ui.CSS_fileUsed=function(t){t.elFile.classList.add("used")},ui.CSS_fileUnused=function(t){t.elFile.classList.remove("used")},ui.newTrack=function(){ui.tracks.push(new ui.Track(this))},ui.panelSection=function(t){ui.dom.app.dataset.panel=t},ui.resize=function(){ui.screenWidth=document.body.clientWidth,ui.screenHeight=document.body.clientHeight,ui.gridColsWidth=ui.dom.gridCols.getBoundingClientRect().width,ui.gridColsHeight=ui.dom.tracks.clientHeight,ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,ui.timeline.update(),ui.tracksBg.update()},ui.sample={select:function(t){t.data.elSample.classList.toggle("selected",t.data.selected)}},ui.CSS_sampleCreate=function(t){var e=wisdom.cE(Handlebars.templates.sample(t.data.gsfile))[0];t.data.elSample=e,t.data.elSVG=wisdom.qS(e,"svg"),t.data.elName=wisdom.qS(e,".name"),t.data.elCropStart=wisdom.qS(e,".crop.start"),t.data.elCropEnd=wisdom.qS(e,".crop.end"),wisdom.qSA(e,"*").forEach(function(e){e.gsSample=t})},ui.CSS_sampleTrack=function(t){t.data.track.elColLinesTrack.appendChild(t.data.elSample)},ui.CSS_sampleWhen=function(t){wisdom.css(t.data.elSample,"left",t.when*ui.BPMem+"em")},ui.CSS_sampleDelete=function(t){t.data.elSample.remove()},ui.CSS_sampleDuration=function(t){wisdom.css(t.data.elSample,"width",t.duration*ui.BPMem+"em"),ui.CSS_sampleWaveform(t)},ui.CSS_sampleOffset=ui.CSS_sampleWaveform=function(t){if(t.wBuffer){var e=t.offset,i=Math.min(t.duration,t.bufferDuration-e),n=i*ui.BPMem;wisdom.css(t.data.elSVG,"width",n+"em"),t.wBuffer.waveformSVG(t.data.elSVG,~~(50*n),50,e,i)}},ui.selectTool=function(){var t;return function(e){var i,n=ui.dom.toolBtns.tool[e];n!==t&&(t&&(t.classList.remove("active"),i=ui.tool[ui.currentTool],i.mouseup&&i.mouseup({}),i.end&&i.end()),t=n,n.classList.add("active"),ui.dom.grid.dataset.tool=ui.currentTool=e,i=ui.tool[e],i.start&&i.start())}}(),ui.setFilesWidth=function(t){wisdom.css(ui.dom.panel,"width",t+"px"),ui.filesWidth=t=ui.dom.panel.clientWidth,ui.gridColsWidth=ui.screenWidth-t,ui.trackLinesWidth=ui.gridColsWidth-ui.trackNamesWidth,wisdom.css(ui.dom.grid,"left",t+"px"),wisdom.css(ui.dom.visual,"width",t+ui.trackNamesWidth+"px"),wisdom.css(ui.dom.menu,"left",t+ui.trackNamesWidth+"px"),ui.timeline.update(),ui.tracksBg.update()},ui.gridScrollTop=0,ui.setGridScrollTop=function(t){ui.dom.gridCols.scrollTop=ui.gridScrollTop=t<=0?0:Math.min(t,ui.tracks.length*ui.gridEm-ui.gridColsHeight),ui.updateGridTopShadow()},ui.gridZoom=1,ui.setGridZoom=function(t,e,i){t=Math.min(Math.max(1,t),8);var n=t/ui.gridZoom;ui.gridZoom=t,ui.gridEm*=n,wisdom.css(ui.dom.gridEm,"fontSize",t+"em"),ui.dom.grid.dataset.sampleSize=ui.gridEm<40?"small":ui.gridEm<80?"medium":"big",ui.setGridScrollTop(-(i-(ui.gridScrollTop+i)*n)),ui.setTrackLinesLeft(e-(-ui.trackLinesLeft+e)*n),ui.timeline.update(),ui.tracksBg.update()},ui.setTrackLinesLeft=function(t){ui.trackLinesLeft=t=Math.min(~~t,0),wisdom.css(ui.dom.tracksLines,"marginLeft",t/ui.gridEm+"em"),ui.updateGridLeftShadow()},ui.trackNamesWidth=0,ui.setTrackNamesWidth=function(t){var e,i=ui.trackNamesWidth;wisdom.css(ui.dom.tracksNames,"width",t+"px"),ui.trackNamesWidth=t=ui.dom.tracksNames.getBoundingClientRect().width,ui.trackLinesWidth=ui.gridColsWidth-t,e=ui.filesWidth+t,wisdom.css(ui.dom.gridColB,"left",t+"px"),wisdom.css(ui.dom.timeline,"left",t+"px"),wisdom.css(ui.dom.visual,"width",e+"px"),wisdom.css(ui.dom.menu,"left",e+"px"),ui.trackLinesLeft<0&&ui.setTrackLinesLeft(ui.trackLinesLeft-(t-i)),ui.timeline.update(),ui.tracksBg.update()},ui.toggleTracks=function(t){for(var e,i=0,n=t.isOn&&1===ui.nbTracksOn;e=ui.tracks[i++];)e.toggle(n);t.toggle(!0)},function(){var t=2,e="rgba(0,0,0,.3)",i="px "+t+"px "+e;ui.updateGridLeftShadow=function(){var t=-ui.trackLinesLeft;wisdom.css(ui.dom.tracksNames,"boxShadow",t?Math.min(2+t/8,5)+"px 0"+i:"none")},ui.updateGridTopShadow=function(){var t=ui.gridScrollTop;wisdom.css(ui.dom.gridHeader,"boxShadow",t?"0px "+Math.min(2+t/8,5)+i:"none")}}(),ui.Track=function(t,e){e=e||{},this.grid=t,this.id=ui.tracks.length,this.elColNamesTrack=wisdom.cE("<div class='track'>")[0],this.elColLinesTrack=wisdom.cE("<div class='track'>")[0],ui.dom.tracksNames.appendChild(this.elColNamesTrack),ui.dom.tracksLines.appendChild(this.elColLinesTrack),this.elColNamesTrack.uitrack,this.elColLinesTrack.uitrack=this,this.wfilters=wa.wctx.createFilters(),this.samples=[],this.initToggle().initEditName().toggle(e.toggle!==!1).editName(e.name||"")},ui.Track.prototype={removeSample:function(t){var e=this.samples.indexOf(t);e>=0&&this.samples.splice(e,1)}},ui.Track.prototype.initEditName=function(){var t=this;return this.elName=wisdom.cE("<span class='name text-overflow'>")[0],this.elName.ondblclick=this.editName.bind(this,!0),this.elColNamesTrack.appendChild(this.elName),this.elNameInput=wisdom.cE("<input type='text'/>")[0],this.elColNamesTrack.appendChild(this.elNameInput),this.elNameInput.onblur=function(){t.editName(this.value).editName(!1)},this.elNameInput.onkeydown=function(e){13!==e.keyCode&&27!==e.keyCode||t.editName(13===e.keyCode?this.value:t.name).editName(!1),e.stopPropagation()},this},ui.Track.prototype.editName=function(t){var e=this.elNameInput,i="Track "+(this.id+1);return"string"==typeof t?(t=t.replace(/^\s+|\s+$/,"").replace(/\s+/g," "),t=t===i?"":t,this.elName.classList.toggle("empty",""===t),this.elName.textContent=t||i,this.name=t):t?(this.elColNamesTrack.classList.add("editing"),e.value=this.name||i,e.focus(),e.select()):(e.blur(),this.elColNamesTrack.classList.remove("editing")),this},ui.Track.prototype.initToggle=function(){var t=this;return this.elToggle=wisdom.cE("<a class='toggle icon circle'>")[0],this.elColNamesTrack.appendChild(this.elToggle),this.elToggle.oncontextmenu=function(){return!1},this.elToggle.onmousedown=function(e){0===e.button?t.toggle():2===e.button&&ui.toggleTracks(t)},this},ui.Track.prototype.toggle=function(t){return"boolean"!=typeof t&&(t=!this.isOn),this.isOn!==t&&(this.wfilters.gain(+t),this.isOn=t,this.grid.nbTracksOn+=t?1:-1,this.elToggle.classList.toggle("on",t),this.elColNamesTrack.classList.toggle("off",!t),this.elColLinesTrack.classList.toggle("off",!t)),this},function(){var t=new walContext,e=t.ctx.createAnalyser();e.fftSize=256,t.filters.pushBack(e),window.wa={wctx:t,ctx:t.ctx,analyser:e,analyserArray:new Uint8Array(e.frequencyBinCount),composition:t.createComposition()}}(),wa.oscilloscope=function(){var t=0,e=Math.PI/2;return function(i,n,s){var a,o=0,r=i.width,l=i.height,u=s.length,c=u/2,d=r/(u-1);for(n.globalCompositeOperation="source-in",n.fillStyle="rgba("+Math.round(255-255*t)+","+Math.round(64*t)+","+Math.round(255*t)+","+(.95-.25*(1-Math.cos(t*e)))+")",n.fillRect(0,0,r,l),t=0,n.globalCompositeOperation="source-over",n.save(),n.translate(0,l/2),n.beginPath(),n.moveTo(0,0);o<u;++o)a=(s[o]-128)/128,t=Math.max(Math.abs(a),t),a*=.5-Math.cos((o<c?o:u-o)/c*Math.PI)/2,n.lineTo(o*d,a*l);n.lineJoin="round",n.lineWidth=1+Math.round(2*t),n.strokeStyle="rgba(255,255,255,"+Math.min(.3+4*t,1)+")",n.stroke(),n.restore()}}(),ui.BPMem=1,gs.bpm=function(t,e){if(!arguments.length)return gs._bpm;var i,n=ui.BPMem,s=gs.currentTime()*n;gs._bpm=Math.max(20,Math.min(t,999)),ui.bpm(gs._bpm),ui.BPMem=t/60,i=n/ui.BPMem,wa.composition.samples.forEach(function(t){t.when=t.when*i,ui.CSS_sampleDuration(t),ui.CSS_sampleOffset(t)}),gs.currentTime(s/ui.BPMem)},gs.currentTime=function(t){return arguments.length?(wa.composition.currentTime(t),t=wa.composition.currentTime(),ui.currentTimeCursor.at(t),void ui.clock.setTime(t)):wa.composition.currentTime()},function(){function t(t,e){var i=JSON.parse(e.target.result);gs.bpm(i.bpm),i.files.forEach(gs.fileCreate),i.tracks.forEach(function(t){for(var e=t[0];e>=ui.tracks.length;)ui.newTrack();ui.tracks[e].toggle(t[1]).editName(t[2])}),i.samples.forEach(function(t){var e=gs.sample.create(gs.files[t[1]]);e.data.gsfile.samplesToSet.push(e),gs.sample.inTrack(e,t[0]),gs.sample.when(e,t[2]/ui.BPMem),gs.sample.slip(e,t[3]/ui.BPMem),gs.sample.duration(e,t[4]/ui.BPMem),wa.composition.update(e,"ad")}),t()}gs.load=function(e){return new Promise(function(i,n){if(e){var s=new FileReader;s.onload=t.bind(null,i),s.readAsText(e)}else i()})}}(),function(){function t(t){var e=t.length-1;return t.reduce(function(t,i,n){return t+"\t\t"+JSON.stringify(i)+(n<e?",":"")+"\n"},"")}gs.save=function(){var e=gs.files.map(function(t){return[t.id,t.fullname,t.file?t.file.size:t.size,t.wbuff?t.wbuff.buffer.duration:t.bufferDuration]}),i=wa.composition.samples.map(function(t){return[t.data.track.id,t.data.gsfile.id,ui.BPMem*t.when,ui.BPMem*t.offset,ui.BPMem*t.duration]}),n=ui.tracks.reduce(function(t,e){return(!e.isOn||e.samples.length||e.name||e.wfilters&&e.wfilters.length)&&t.push([e.id,e.isOn,e.name]),t},[]);return{download:"gridsound-composition.gs",href:"data:text/plain;charset=utf-8,"+encodeURIComponent('{\n\t"saveformat": 2,\n\t"bpm": '+gs._bpm+',\n\t"files": [\n'+t(e)+'\t],\n\t"tracks": [\n'+t(n)+'\t],\n\t"samples": [\n'+t(i)+"\t]\n}")}}}(),gs.reset=function(){return ui.tracks.forEach(function(t){t.editName(""),t.toggle(!0)}),wa.composition.samples.forEach(function(t){gs.sample.select(t,!0)}),gs.samplesDelete(),gs.files.forEach(function(t){t.elFile.remove()}),gs.files=[],this},gs.fileCreate=function(t){var e=new gs.File(t);return e.id=gs.files.length,gs.files.push(e),ui.dom.filesList.appendChild(e.elFile),e},gs.fileDelete=function(t){wa.composition.samples.filter(function(e){return e.data.gsfile===t}).forEach(function(t){gs.sample.delete(t)}),gs.files.splice(gs.files.indexOf(t),1),t.delete()},function(){gs.filePlay=function(i){t&&t.stop(),i.isLoaded&&(wisdom.css(e,"transitionDuration",0),wisdom.css(e,"left",0),i.elWaveformWrap.appendChild(e),t=wa.wctx.createSample().setBuffer(i.wbuff).onended(gs.fileStop).load().start(),setTimeout(function(){wisdom.css(e,"transitionDuration",i.wbuff.buffer.duration+"s"),wisdom.css(e,"left","100%")},20))},gs.fileStop=function(){t&&(t.stop(),e.remove())};var t,e=wisdom.cE("<div class='cursor'>")[0]}(),function(){var t;ui.dom.filesInput.onchange=function(){t&&(t.joinFile(this.files[0]),t=null)},gs.File=function(e){var i=this;this.isLoaded=this.isLoading=!1,this.file=e.length?null:e,this.bufferDuration=e.length?e[3]:null,this.fullname=e.name||e[1],this.name=this.fullname.replace(/\.[^.]+$/,""),this.nbSamples=0,this.elFile=wisdom.cE(Handlebars.templates.file(this))[0],this.elName=wisdom.qS(this.elFile,".name"),this.elIcon=wisdom.qS(this.elFile,".icon"),this.samplesToSet=[],this.file?ui.CSS_fileUnloaded(this):(this.size=e[2],ui.CSS_fileWithoutData(this)),this.elFile.oncontextmenu=function(){return!1},this.elFile.ondragstart=this.dragstart.bind(this),this.elFile.onmousedown=function(t){0!==t.button&&gs.fileStop(),t.ctrlKey&&gs.fileDelete(i)},this.elFile.onclick=function(){i.isLoaded?gs.filePlay(i):i.file?i.isLoading||i.load(gs.filePlay):(alert("Choose the file to associate or drag and drop "+i.name),t=i,ui.dom.filesInput.click())}}}(),gs.File.prototype.delete=function(){this.elFile.remove()},function(){document.body.addEventListener("mousemove",function(i){t&&(wisdom.css(e,"left",i.pageX+"px"),wisdom.css(e,"top",i.pageY+"px"))}),document.body.addEventListener("mouseup",function(i){t&&(e.remove(),t=null,ui.cursor("app",null))}),ui.dom.gridColB.addEventListener("mouseup",function(e){if(t){var i=gs.sample.create(t);gs.sample.inTrack(i,ui.getTrackFromPageY(e.pageY).id),gs.sample.when(i,ui.getGridSec(e.pageX)),wa.composition.update(i,"ad")}}),gs.File.prototype.dragstart=function(i){return this.isLoaded&&!t&&(t=this,e=this.elSVG.cloneNode(!0),wisdom.css(e,"left",i.pageX+"px"),wisdom.css(e,"top",i.pageY+"px"),e.classList.add("dragging"),document.body.appendChild(e),ui.cursor("app","grabbing")),!1};var t,e}(),gs.File.prototype.joinFile=function(t){this.file=t,ui.CSS_fileUnloaded(this),this.fullname!==t.name&&(this.fullname=t.name,this.name=this.fullname.replace(/\.[^.]+$/,""),this.elName.textContent=this.name),this.samplesToSet.length&&this.load(function(t){t.samplesToSet.forEach(function(e){e.setBuffer(t.wbuff),e.data.elName.textContent=t.name,ui.CSS_sampleWaveform(e),ui.CSS_sampleDuration(e)})})},gs.File.prototype.load=function(t){var e=this;this.isLoading=!0,ui.CSS_fileLoading(this),wa.wctx.createBuffer(this.file).then(function(i){e.wbuff=i,e.isLoaded=!0,e.isLoading=!1,e.elSVG=wisdom.qS(e.elFile,"svg"),e.elWaveformWrap=e.elSVG.parentNode,i.waveformSVG(e.elSVG,400,50),ui.CSS_fileLoaded(e),t(e)},function(){e.isLoading=!1,ui.CSS_fileError(e),alert('At this day, the file: "'+e.fullname+'" can not be decoded by your browser.\n')})},gs.samplesForEach=function(t,e){t&&(t.data.selected?gs.selectedSamples.forEach(e):e(t))},function(){gs.samplesCopy=function(){var i=1/0,n=-(1/0);e=gs.selectedSamples.map(function(t){return i=Math.min(i,t.when),n=Math.max(n,t.when+t.duration),t}),ui.isMagnetized&&(i=ui.secFloor(i),n=ui.secCeil(n)),t=n-i},gs.samplesPaste=function(){gs.samplesUnselect(),e.forEach(function(e){var i=gs.sample.create(e.data.gsfile);gs.sample.inTrack(i,e.data.track.id),gs.sample.when(i,e.when+t),gs.sample.slip(i,e.offset),gs.sample.duration(i,e.duration),wa.composition.update(i,"ad"),gs.sample.select(i,!0)}),gs.samplesCopy()};var t,e=[]}(),gs.samplesCut=function(t,e){e-=t.when,gs.samplesForEach(t,function(t){gs.sample.cut(t,e)})},gs.samplesDelete=function(t){t&&(t.data?gs.sample.delete(t):(gs.selectedSamples.slice(0).forEach(gs.sample.delete),gs.selectedSamples=[]))},gs.samplesDuration=function(t,e){function i(t){n=Math.min(n,t.duration),e=Math.min(e,t.bufferDuration-t.duration)}var n=1/0;return t.data.selected?gs.selectedSamples.forEach(i):i(t),e<0&&(e=-Math.min(n,-e)),gs.samplesForEach(t,function(t){gs.sample.duration(t,t.duration+e)}),e},gs.samplesWhen=function(t,e){return e<0&&(e=-Math.min(-e,t.data.selected?gs.selectedSamples.reduce(function(t,e){return Math.min(t,e.when)},1/0):t.when)),gs.samplesForEach(t,function(t){gs.sample.when(t,Math.max(0,t.when+e))}),e},gs.samplesSlip=function(t,e){return e=e<0?-Math.min(-e,t.data.selected?gs.selectedSamples.reduce(function(t,e){return Math.min(t,e.bufferDuration-e.offset)},1/0):t.bufferDuration-t.offset):Math.min(e,t.data.selected?gs.selectedSamples.reduce(function(t,e){return Math.min(t,e.offset)},1/0):t.offset),gs.samplesForEach(t,function(t){gs.sample.slip(t,t.offset-e)}),e},gs.samplesCropEnd=gs.samplesDuration,gs.samplesCropStart=function(t,e){return e=-gs.samplesDuration(t,-e),e&&(gs.samplesWhen(t,e),gs.samplesSlip(t,-e)),e},gs.samplesUnselect=function(){gs.selectedSamples.forEach(function(t){t.data.selected=!1,ui.sample.select(t)}),gs.selectedSamples=[]},gs.sample.create=function(t){var e=wa.wctx.createSample(),i=wisdom.cE(Handlebars.templates.sample(t))[0];return e.data={selected:!1,gsfile:t,elSample:i,elSVG:wisdom.qS(i,"svg"),elName:wisdom.qS(i,".name"),elCropStart:wisdom.qS(i,".crop.start"),elCropEnd:wisdom.qS(i,".crop.end")},wisdom.qSA(i,"*").forEach(function(t){t.gsSample=e}),t.file?e.setBuffer(t.wbuff):e.setBufferDuration(t.bufferDuration),wa.composition.add(e),++t.nbSamples,ui.CSS_fileUsed(t),ui.CSS_sampleDuration(e),ui.sample.select(e),e},gs.sample.cut=function(t,e){if(e<t.duration){var i=gs.sample.create(t.data.gsfile);gs.sample.inTrack(i,t.data.track.id),gs.sample.when(i,t.when+e),gs.sample.slip(i,t.offset+e),gs.sample.duration(i,t.duration-e),gs.sample.duration(t,e),wa.composition.update(t,"mv"),wa.composition.update(i,"ad")}},gs.sample.delete=function(t){if(t){var e=t.data;e.oldSelected=!!e.selected,gs.sample.select(t,!1),--e.gsfile.nbSamples||ui.CSS_fileUnused(e.gsfile),t.stop(),e.track.removeSample(t),e.oldTrack=e.track,t.data.track=void 0,wa.composition.remove(t),ui.CSS_sampleDelete(t)}},gs.sample.duration=function(t,e){t.duration=Math.max(0,Math.min(e,t.bufferDuration)),ui.CSS_sampleDuration(t)},gs.sample.inTrack=function(t,e){var i=t.data,n=ui.tracks[e];n!==i.track&&(t.disconnect(),t.connect(n.wfilters),i.track&&i.track.removeSample(t),i.track=n,n.samples.push(t),ui.CSS_sampleTrack(t))},gs.sample.mute=function(t){lg("sample muted (in development)")},gs.sample.select=function(t,e){t&&t.data.selected!==e&&("boolean"!=typeof e&&(e=!t.data.selected),e?gs.selectedSamples.push(t):gs.selectedSamples.splice(gs.selectedSamples.indexOf(t),1),t.data.selected=e,ui.sample.select(t))},gs.sample.slip=function(t,e){t.offset=Math.min(t.bufferDuration,Math.max(e,0)),ui.CSS_sampleOffset(t)},gs.sample.when=function(t,e){t.when=e,ui.CSS_sampleWhen(t)},function(){function t(t,i){i=i.deltaY,ui.bpm(ui._bpm+(i>0?-t:i?t:0)),clearTimeout(e),e=setTimeout(gs.bpm.bind(null,ui._bpm),400)}ui.dom.bpmInt.onwheel=t.bind(null,1),ui.dom.bpmDec.onwheel=t.bind(null,.01),ui.dom.bpm.onmousedown=function(t){ui.dom.bpm.classList.toggle("clicked"),t.stopPropagation()},ui.dom.bpmList.onmousedown=function(t){var e=+t.target.textContent;return e&&gs.bpm(e),!1},document.body.addEventListener("mousedown",function(){ui.dom.bpm.classList.remove("clicked")});var e}(),ui.dom.clockUnits.onclick=function(t){var e=t.target.className;return"s"!==e&&"b"!==e||ui.clock.setUnit(gs.clockUnit=e),!1},function(){var t,e=!1,i={panel:function(t){var e=t.pageX;ui.setFilesWidth(e<35?0:e)},trackNames:function(t){var e=t.pageX-ui.dom.grid.getBoundingClientRect().left;ui.setTrackNamesWidth(e<35?0:e)}};wisdom.qSA(".extend").forEach(function(n){n.onmousedown=function(n){0===n.button&&(e=!0,ui.cursor("app","col-resize"),t=i[this.dataset.mousemoveFn])}}),document.body.addEventListener("mouseup",function(t){0===t.button&&e&&(e=!1,ui.cursor("app",null))}),document.body.addEventListener("mousemove",function(i){e&&t(i)})}(),function(){function t(){a.forEach(function(t){gs.files.some(function(e){var i=e.file?e.file.size:e.size;if(e.fullname===t.name&&i===t.size)return e.file||e.joinFile(t),!0})||gs.fileCreate(t)})}function e(e){for(var a,o=0,r=[];a=e[o++];)a.webkitGetAsEntry&&(a=a.webkitGetAsEntry())?r.push(i(a)):(a=a.getAsFile())&&(lg("item.getAsFile()",a),n(a));Promise.all(r).then(function(){gs.load(s).then(function(){t()})})}function i(t){return new Promise(function(e){if(t.isFile)t.file(function(t){n(t),e()});else if(t.isDirectory){var s=t.createReader();s.readEntries(function(t){var n=[];t.forEach(function(t){n.push(i(t))}),Promise.all(n).then(e)})}else e()})}function n(t){switch(/[^.]*.?([^.]*)$/.exec(t.name)[1].toLowerCase()){case"gs":s=t,gs.reset();break;case"mp3":case"mpg":case"mpeg":case"wav":case"wave":case"ogg":a.push(t)}}var s,a;document.body.ondragover=function(){return!1},document.body.ondrop=function(i){var o,r=0,l=i&&i.dataTransfer;if(a=[],s=!1,l.items&&l.items.length)e(l.items);else{for(;o=l.files[r++];)n(o);gs.load(s).then(function(){t()})}return!1}}(),function(){function t(t){return n.every(function(e){return e===t||!i.contains(e)})}function e(t){i.toggle("used",t),i.toggle("loaded",t),i.toggle("unloaded",t)}ui.dom.filesFilters.onclick=ui.dom.filesFilters.oncontextmenu=function(){return!1},ui.dom.filesFilters.onmouseup=function(n){var s,a=n.target;"A"===a.nodeName&&(0===n.button?i.toggle(a.className):2===n.button&&(s=i.contains(a.className)&&t(a.className),e(s),s||i.add(a.className)))};var i=ui.dom.filesFilters.classList,n=["used","loaded","unloaded"];e(!0)}(),function(){function t(){n&&(ui.selectTool(n),n=null),e=!1}ui.px_x=ui.px_y=ui.px_xRel=ui.px_yRel=0,window.addEventListener("blur",t),ui.dom.gridCols.onwheel=function(t){if("zoom"===ui.currentTool)return ui.tool.zoom.wheel(t),!1},ui.dom.gridCols.onscroll=function(){ui.gridScrollTop=ui.dom.gridCols.scrollTop,ui.updateGridTopShadow()},ui.dom.tracksLines.oncontextmenu=function(){return!1},ui.dom.tracksLines.onmousedown=function(t){if(!e){e=!0,i=ui.getGridSec(t.pageX),ui.px_x=t.pageX,ui.px_y=t.pageY,2===t.button&&(n=ui.currentTool,ui.selectTool("delete"));var s=ui.tool[ui.currentTool].mousedown;s&&s(t)}},document.body.onwheel=function(t){if(t.ctrlKey)return!1},document.body.addEventListener("mousemove",function(t){if(e){var n=ui.tool[ui.currentTool].mousemove,s=ui.getGridSec(t.pageX);ui.px_xRel=t.pageX-ui.px_x,ui.px_yRel=t.pageY-ui.px_y,ui.px_x=t.pageX,ui.px_y=t.pageY,n&&(i+=n(t,s-i))}}),document.body.addEventListener("mouseup",function(i){if(e){var n=ui.tool[ui.currentTool].mouseup;n&&n(i),t()}});var e,i,n}(),function(){function t(t){i=ui.currentTool,ui.selectTool(t.name)}function e(e,n){"keydown"===n.type?t(e):i&&(ui.selectTool(i),i=null)}keyboardRouter({fn:e,when:"down,up",keys:["alt"],name:"hand"},{fn:e,when:"down,up",keys:["ctrl"],name:"zoom"},{fn:e,when:"down,up",keys:["shift"],name:"select"},{fn:t,keys:["z"],name:"zoom"},{fn:t,keys:["s"],name:"slip"},{fn:t,keys:["d"],name:"delete"},{fn:t,keys:["c"],name:"cut"},{fn:t,keys:["v"],name:"select"},{fn:t,keys:["b"],name:"paint"},{fn:t,keys:["h"],name:"hand"},{fn:gs.playStop,keys:[" "]},{fn:gs.playPause,keys:["ctrl"," "]},{fn:gs.samplesDelete,keys:["delete"]},{fn:ui.btnMagnet.toggle,keys:["g"]},{fn:gs.samplesCopy,keys:["ctrl","c"]},{fn:gs.samplesPaste,keys:["ctrl","v"]},{fn:gs.history.undo,keys:["ctrl","z"]},{fn:gs.history.redo,keys:["ctrl","shift","z"]});var i}(),ui.dom.btnFiles.onclick=ui.panelSection.bind(null,"files"),ui.dom.btnHistory.onclick=ui.panelSection.bind(null,"history"),window.onresize=ui.resize(),ui.dom.toolBtns.tool={},ui.dom.toolBtns.forEach(function(t){ui.dom.toolBtns.tool[t.dataset.tool]=t,t.onclick=ui.selectTool.bind(null,t.dataset.tool)}),function(){ui.tool.cut={mousedown:function(e){t=e.target.gsSample},mouseup:function(e){t&&gs.samplesCut(t,ui.getGridSec(e.pageX)),t=null}};var t}(),function(){function t(t){var e=t.target.gsSample;e&&(gs.history.push("delete",{samples:[e]}),gs.samplesDelete(e))}ui.tool.delete={mousedown:t,mousemove:t}}(),ui.tool.hand={start:function(){ui.cursor("grid","grab")},end:function(){ui.cursor("grid",null)},mousedown:function(){ui.cursor("app","grabbing")},mouseup:function(){ui.cursor("app",null)},mousemove:function(t){ui.setTrackLinesLeft(ui.trackLinesLeft+ui.px_xRel),ui.setGridScrollTop(ui.gridScrollTop-ui.px_yRel),ui.timeline.update(),ui.tracksBg.update()}},ui.tool.mute={},function(){ui.tool.paint={mousedown:function(l){var u=l.target.gsSample;!u&&gs.selectedSamples.length?(gs.history.push("select",{samples:gs.selectedSamples.slice()}),gs.samplesUnselect()):u&&(e=u.data.track.id,i=u.when,n=u.offset,s=u.duration,o=l.target.classList.contains("start"),a=o||l.target.classList.contains("end"),a?(r=o?"crop":"cropEnd",u.data[o?"elCropStart":"elCropEnd"].classList.add("hover")):r="move",t=u,ui.cursor("app",a?o?"w-resize":"e-resize":"grabbing"))},mouseup:function(){t&&(gs.samplesForEach(t,function(t){wa.composition.update(t,"mv")}),a&&(t.data[o?"elCropStart":"elCropEnd"].classList.remove("hover"),a=o=!1),t.data.track.id===e&&t.when===i&&t.offset===n&&t.duration===s||gs.history.push(r,{sample:t,track:t.data.track.id-e,when:t.when-i,offset:t.offset-n,duration:t.duration-s}),t=e=i=n=s=null,ui.cursor("app",null))},mousemove:function(e,i){if(t){if(!a){e=e.target;var n,s=1/0,r=e.uitrack||e.gsSample&&e.gsSample.data.track;r&&(t.data.selected?(n=r.id-t.data.track.id,n<0&&(gs.selectedSamples.forEach(function(t){s=Math.min(t.data.track.id,s)}),n=-Math.min(s,-n)),gs.selectedSamples.forEach(function(t){gs.sample.inTrack(t,t.data.track.id+n);
})):gs.sample.inTrack(t,r.id))}return a?o?gs.samplesCropStart(t,i):gs.samplesCropEnd(t,i):gs.samplesWhen(t,i)}}};var t,e,i,n,s,a,o,r}(),function(){ui.tool.select={mousedown:function(i){var n=i.target.gsSample;o=[],i.shiftKey?n&&(o.push(n),gs.sample.select(n)):(gs.selectedSamples.forEach(function(t){t!==n&&o.push(t)}),gs.samplesUnselect(),gs.sample.select(n,!0)),t=i.pageX,e=i.pageY,s=!0},mouseup:function(t){o&&o.length&&(gs.history.push("select",{samples:o}),o=null),s=a=!1,wisdom.css(l,"width","0px"),wisdom.css(l,"height","0px"),l.remove()},mousemove:function(u){if(s){var c=u.pageX,d=u.pageY;if(!a&&Math.max(Math.abs(c-t),Math.abs(d-e))>5&&(++r,a=!0,i=ui.getTrackFromPageY(e).id,n=ui.getGridSec(t),ui.dom.tracksLines.appendChild(l)),a){var f=ui.getTrackFromPageY(d),m=f?f.id:0,p=Math.min(i,m),h=Math.max(i,m),g=Math.max(0,ui.getGridSec(c)),v=Math.min(n,g),w=Math.max(n,g);wa.composition.samples.forEach(function(t){if(p<=t.data.track.id&&t.data.track.id<=h){var e=t.when,i=t.duration+e;if(v<=e&&e<w||v<i&&i<=w||e<=v&&w<=i)return void(t.data.selected||(t.data.squareSelected=r,gs.sample.select(t,!0),o.push(t)))}t.data.squareSelected===r&&(delete t.data.squareSelected,gs.sample.select(t,!1),o.splice(o.indexOf(t),1))}),wisdom.css(l,"top",p+"em"),wisdom.css(l,"left",v*ui.BPMem+"em"),wisdom.css(l,"width",(w-v)*ui.BPMem+"em"),wisdom.css(l,"height",h-p+1+"em")}}}};var t,e,i,n,s,a,o,r=0,l=wisdom.cE("<div id='squareSelection'>")[0]}(),function(){ui.tool.slip={mousedown:function(i){t=i.target.gsSample,t&&(e=t.offset)},mouseup:function(){t&&(gs.history.push("slip",{sample:t,offset:e-t.offset}),gs.samplesForEach(t,function(t){wa.composition.update(t,"mv")})),t=null},mousemove:function(e,i){if(t)return gs.samplesSlip(t,i)}};var t,e}(),function(){function t(t,e){ui.setGridZoom(ui.gridZoom*e,t.pageX-ui.filesWidth-ui.trackNamesWidth,t.pageY-ui.gridColsY)}ui.tool.zoom={start:function(){ui.cursor("grid","zoom-in")},end:function(){ui.cursor("grid",null)},keydown:function(t){18===t.keyCode&&ui.cursor("grid","zoom-out")},keyup:function(t){18===t.keyCode&&ui.cursor("grid","zoom-in")},wheel:function(e){t(e,e.deltaY<0?1.1:.9)},mousedown:function(e){0===e.button&&t(e,e.altKey?.7:1.3)}}}(),function(){ui.resize(),ui.setFilesWidth(200),ui.setTrackLinesLeft(0),ui.setTrackNamesWidth(125),ui.setGridZoom(1.5,0,0),ui.visualCanvas.on(),ui.btnMagnet.toggle(!0),ui.tracksBg.update(),ui.historyList.reset(),ui.timelineLoop.toggle(!1),gs.bpm(120),gs.currentTime(0),wa.composition.onended(gs.compositionStop),ui.dom.btnFiles.click(),wisdom.qS(ui.dom.clockUnits,".s").click(),wisdom.qS(ui.dom.menu,"[data-tool='paint']").click();for(var t=0;t<42;++t)ui.newTrack()}();