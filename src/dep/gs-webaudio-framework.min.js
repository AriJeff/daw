"use strict";function gswaFramework(){this.ctx=new AudioContext,this.sampleGroup=new gswaSampleGroup,this.gain=this.ctx.createGain(),this.analyser=this.ctx.createAnalyser(),this.destination=this.ctx.createGain(),this.gain.connect(this.ctx.destination),this.analyser.connect(this.gain),this.destination.connect(this.analyser),this.on={},this.do={},this.actions=[],this.actionsInd=0,this.cmparr=this.compositions=[],this.srcarr=this.sources=[],this.trkarr=this.tracks=[],this.numberOfSourcesPlaying=0,this.currentComposition=null,this.bpm=60;for(var o in gswaFramework.do)this.do[o]=gswaFramework.do[o].bind(this),this.on[o]=function(){};this.on.undo=this.on.redo=this.on.pushAction=this.on.popAction=this.on.setBPMthen=this.on.loadingSource=this.on.endedSource=function(){}}gswaFramework.do={},gswaFramework.actions={},gswaFramework.prototype.pushAction=function(o,t,a){a=arguments.length<3?t:a;var s=this.actionsInd+1,n=this.actions.length-s,i=gswaFramework.actions[o].bind(this,t),r=gswaFramework.actions[o+"_undo"].bind(this,a),e={name:o,data:t,undata:a,do:i,undo:r};if(n>0)for(this.actions.splice(s);n--;)this.on.popAction();return this.actionsInd=s,this.actions.push(e),this.on.pushAction(e),i},gswaFramework.prototype.redo=function(){this.actionsInd<this.actions.length-1&&(--this.actionsInd,this.on.redo())},gswaFramework.prototype.undo=function(){this.actionsInd>0&&(++this.actionsInd,this.on.undo())},gswaFramework.actions.sampleCreate=function(o){var t=o.srcobj;++t.numberOfSampleInstances,o.offset=o.offset||0,o.duration=o.duration||t.metadata.duration,o.sample=t.bufferSample,this.sampleGroup.addSample(o),o.userData=this.on.addSample(o),this.on.sampleWhen(o),this.on.sampleDuration(o),this.on.sampleInTrack(o)},gswaFramework.actions.sampleCreate_undo=function(o){},gswaFramework.do.addComposition=function(o){this.cmparr.push(o),o.userData=this.on.addComposition(o)},gswaFramework.do.addSample=function(o){this.pushAction("sampleCreate",Object.assign({},o))()},gswaFramework.do.addSamples=function(o){o.forEach(this.do.addSample),this.on.addSamples(o)},gswaFramework.do.addSource=function(o){var t=new gswaBufferSample;o.bufferSample=t,o.numberOfSampleInstances=0,t.setMetadata(o.metadata),this.srcarr.push(o),o.userData=this.on.addSource(o),o.data&&this.do.fillSource(o,o.data)},gswaFramework.do.addSources=function(o){o.forEach(this.do.addSource),this.on.addSources(o)},gswaFramework.do.addTrack=function(o){this.trkarr.push(o),o.smparr=[],o.userData=this.on.addTrack(o)},gswaFramework.do.fillSource=function(o,t){var a=t.name,s=a.lastIndexOf(".");o.data=t,o.metadata.filename=a,o.metadata.name=s<0?a:a.substr(0,s),this.on.fillSource(o),o.numberOfSampleInstances&&this.do.loadSource(o)},gswaFramework.do.loadComposition=function(o){this.currentComposition!==o&&(this.currentComposition=o,this.on.loadComposition(o))},gswaFramework.do.loadSource=function(o){var t=this,a=o.bufferSample,s=o.data;if(s)return a.setContext(this.ctx),a.connect(this.destination),this.on.loadingSource(o),("string"==typeof s?a.setDataFromURL(s):a.setDataFromBlob(s)).then(function(a){return o.metadata.duration=a.duration,t.on.loadSource(o),o})},gswaFramework.do.loadSources=function(o){Promise.all(o.map(this.do.loadSource)).then(this.on.loadSources)},gswaFramework.do.pause=function(){this.on.pause()},gswaFramework.do.play=function(){this.on.play()},gswaFramework.do.playSource=function(o){var t=this,a=o.bufferSample,s=a.start();return++this.numberOfSourcesPlaying,s.addEventListener("ended",function(){--t.numberOfSourcesPlaying,t.on.endedSource(o)}),this.on.playSource(o),s},gswaFramework.do.removeComposition=function(o){var t=this.cmparr.indexOf(o);t>-1&&(this.cmparr.splice(t,1),this.on.removeComposition(o))},gswaFramework.do.removeTrack=function(o){var t=this.trkarr.indexOf(o);t>-1&&(this.trkarr.splice(t,1),this.on.removeTrack(o))},gswaFramework.do.sampleDuration=function(o,t){o.duration=t,this.on.sampleDuration(o)},gswaFramework.do.sampleInTrack=function(o,t){var a=o.trkobj,s=a&&a.smparr;a!==t&&(s&&s.splice(s.indexOf(o),1),t.smparr.push(o),o.trkobj=t,this.on.sampleInTrack(o))},gswaFramework.do.sampleWhen=function(o,t){o.when=t,this.on.sampleWhen(o)},gswaFramework.do.setBPM=function(o,t){function a(o,t){this.sampleGroup.stretch(t/o),this.on.setBPMthen(o)}clearTimeout(this._bpmTimeoutId),o=Math.max(1,Math.min(o,999.999));var s=this.bpm,n=a.bind(this,o,s);this.bpm=o,this.on.setBPM(o),t?this._bpmTimeoutId=setTimeout(n,t):n()},gswaFramework.do.stop=function(){this.on.stop()},gswaFramework.do.stopAllSources=function(){this.sources.forEach(this.do.stopSource),this.on.stopAllSources()},gswaFramework.do.stopSource=function(o){o.bufferSample.stop(),this.on.stopSource(o)},gswaFramework.do.unload=function(){var o=this.currentComposition;o&&(this.currentComposition=null,this.on.unload(o))};